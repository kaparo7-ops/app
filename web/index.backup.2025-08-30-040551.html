<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ â€“ Nawafed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel -->
  <script crossorigin="anonymous" src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .tabular-nums{font-variant-numeric:tabular-nums}
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100}
    .panel{width:900px;max-width:95vw;max-height:90vh;overflow:auto;background:#fff;border-radius:1rem;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .btn{padding:.45rem .7rem;border-radius:.65rem;border:1px solid #e2e8f0;background:#fff}
    .btn-ghost{padding:.3rem .5rem;border-radius:.55rem;border:1px solid transparent;background:transparent}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .btn-warn{background:#b45309;color:#fff;border-color:#b45309}
    .btn-danger{background:#e11d48;color:#fff;border-color:#e11d48}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    .table-wrap{overflow:auto}
    .sticky-right{position:sticky;right:0;background:#fff;z-index:2;box-shadow:-6px 0 6px -6px rgba(0,0,0,.08)}
    .actions .icon{padding:.2rem .35rem;border-radius:.45rem}
    .actions .icon:hover{background:#f1f5f9}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div id="root"></div>

  <!-- Error overlay -->
  <script>
    (function(){
      if(window.__errOverlayInstalled) return; window.__errOverlayInstalled = true;
      function show(msg){
        const d=document.createElement("div");
        d.style.position="fixed"; d.style.inset="0"; d.style.zIndex=99999; d.style.background="rgba(0,0,0,.85)";
        d.innerHTML='<div style="max-width:1000px;margin:24px auto;background:#111;color:#fff;border-radius:12px;padding:16px"><h2 style="margin:0 0 8px">JavaScript Error</h2><pre style="white-space:pre-wrap">'+msg+'</pre></div>';
        document.body.appendChild(d);
      }
      window.addEventListener("error", e=>show((e.error&&e.error.stack)||e.message||String(e)));
      window.addEventListener("unhandledrejection", e=>{
        const r=e.reason; show("Unhandled promise rejection:\\n"+((r&&(r.stack||r.message))||String(r)));
      });
    })();
  </script>

  <script type="text/babel" data-presets="env,react">
    // ===== Core =====
    const FORCED_SERVER = { mode:"server", base:"/api", token:"ChangeMe-LongRandomToken!" };
    const {useState,useEffect,useMemo,useRef} = React;
    const todayISO=()=>new Date().toISOString().slice(0,10);
    const num=v=>{const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?0:n};
    const classNames=(...xs)=>xs.filter(Boolean).join(" ");
    const CURRENCIES=["LYD","USD","EUR"];

    // ===== KV =====
    async function kvGet(key){
      const url = `${FORCED_SERVER.base}/kv/${encodeURIComponent(key)}?token=${FORCED_SERVER.token}`;
      const r = await fetch(url, { credentials:"include" });
      if(!r.ok) throw new Error("kv get failed: "+r.status);
      const j = await r.json(); return j.value;
    }
    async function kvPut(key, value){
      const url = `${FORCED_SERVER.base}/kv/${encodeURIComponent(key)}?token=${FORCED_SERVER.token}`;
      const r = await fetch(url, {
        method:"PUT",
        headers:{ "Content-Type":"application/json", "x-sync-token": FORCED_SERVER.token },
        body: JSON.stringify({value})
      });
      if(!r.ok) throw new Error("kv put failed: "+r.status);
    }
    function useServerState(key, initial){
      const [state,setState]=useState(initial);
      const bootRef=useRef(false);
      useEffect(()=>{(async()=>{
        const remote=await kvGet(key).catch(e=>{throw e});
        if(remote==null){ setState(initial); await kvPut(key, initial); }
        else setState(remote);
        bootRef.current=true;
      })()},[key]);
      const save=v=>{ setState(v); kvPut(key,v).catch(e=>{throw e}); };
      return [state, save, bootRef];
    }

    // ===== Auth =====
    const b64 = u8 => btoa(String.fromCharCode(...u8));
    const randBytes=(n=16)=>{const a=new Uint8Array(n); (window.crypto&&crypto.getRandomValues)?crypto.getRandomValues(a):a.fill(7); return a;};
    const hex = u8 => Array.from(u8).map(b=>b.toString(16).padStart(2,"0")).join("");
    async function pbkdf2(password,saltB64,iterations=150000,len=32){
      try{
        if(!(window.crypto && crypto.subtle)) return "PLAINTEXT:"+password;
        const enc=new TextEncoder();
        const key=await crypto.subtle.importKey("raw",enc.encode(password),"PBKDF2",false,["deriveBits"]);
        const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:Uint8Array.from(atob(saltB64),c=>c.charCodeAt(0)),iterations},key,len*8);
        return hex(new Uint8Array(bits));
      }catch{ return "PLAINTEXT:"+password; }
    }
    function useAuth(){
      const [users,setUsers]=useServerState("nwgd_users",[]);
      const [session,setSession]=useServerState("nwgd_session",null);
      const [sessionTokens,setSessionTokens]=useServerState("nwgd_session_tokens",{});
      const [booted,setBooted]=useState(false);

      useEffect(()=>{(async()=>{
        const remote=await kvGet("nwgd_users").catch(()=>null);
        if(!Array.isArray(remote)||remote.length===0){
          const salt=b64(randBytes(16));
          const passHash=await pbkdf2("admin123",salt,150000);
          await kvPut("nwgd_users",[ {id:1,username:"admin",role:"admin",salt,iterations:150000,passHash} ]);
          setUsers([{id:1,username:"admin",role:"admin",salt,iterations:150000,passHash}]);
        }
        setBooted(true);
      })()},[]);

      async function login(username,password){
        const u=(users||[]).find(x=>x.username.toLowerCase()===String(username).toLowerCase());
        if(!u) return {ok:false,msg:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"};
        const h=await pbkdf2(password,u.salt,u.iterations||150000);
        if(h!==u.passHash) return {ok:false,msg:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"};
        const sid='s'+Date.now()+Math.random().toString(36).slice(2);
        const exp=Date.now()+1000*60*60*24*30;
        const tokens=Object.assign({},(await kvGet("nwgd_session_tokens"))||{});
        tokens[sid]={uid:u.id,username:u.username,role:u.role,exp};
        await kvPut("nwgd_session_tokens",tokens);
        localStorage.setItem("nwgd_sid",sid);
        setSession({uid:u.id,username:u.username,role:u.role,lastActivity:Date.now()});
        return {ok:true};
      }
      async function logout(){
        const sid=localStorage.getItem("nwgd_sid");
        const tokens=Object.assign({},(await kvGet("nwgd_session_tokens"))||{});
        delete tokens[sid];
        await kvPut("nwgd_session_tokens",tokens);
        localStorage.removeItem("nwgd_sid");
        setSession(null);
      }
      useEffect(()=>{(async()=>{
        try{
          const sid=localStorage.getItem("nwgd_sid");
          if(!sid) return;
          const tokens=await kvGet("nwgd_session_tokens");
          const t=tokens&&tokens[sid];
          if(t && t.exp>Date.now()){
            setSession({uid:t.uid,username:t.username,role:t.role,lastActivity:Date.now()});
          }
        }catch(e){}
      })()},[]);
      return {users,setUsers,session,setSession,login,logout,booted};
    }

    // ===== Settings =====
    function useSettings(){ return useServerState("nwgd_settings",{logoUrl:"",logoSize:56}); }

    // ===== Utilities (download/upload) =====
    function downloadText(name, text, mime="application/json"){
      const blob=new Blob([text],{type:mime+";charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }
    function toCSV(rows, headers){
      const esc=s=>('"'+String(s??"").replace(/"/g,'""')+'"');
      const head=headers.map(h=>esc(h.label)).join(",");
      const body=(rows||[]).map(r=>headers.map(h=>esc(h.get(r))).join(",")).join("\n");
      return head+"\n"+body;
    }

    // ===== UI primitives =====
    function Field({label,children,help}){ return (
      <label className="space-y-1 block">
        <div className="text-sm text-slate-600">{label} {help && <span className="text-xs text-slate-400">â€” {help}</span>}</div>
        {children}
      </label>
    );}
    function Card({title,value}){ return <div className="bg-white rounded-2xl shadow p-4">
      <div className="text-sm text-slate-500">{title}</div>
      <div className="text-2xl font-bold mt-1 tabular-nums text-left">{(value??0).toLocaleString? (value??0).toLocaleString(): String(value??"")}</div>
    </div>; }

    // ===== Modals: Settings =====
    function SettingsModal({open,onClose,settings,setSettings}){
      if(!open) return null;
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
              <button className="btn" onClick={onClose}>Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Logo URL)" help="ÙŠØ¸Ù‡Ø± ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©">
                <input className="w-full border rounded-xl px-3 py-2" value={settings.logoUrl||""} onChange={e=>setSettings({...settings,logoUrl:e.target.value})} placeholder="https://example.com/logo.png"/>
              </Field>
              <Field label="Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø± (px)">
                <input type="number" min="24" max="128" className="w-full border rounded-xl px-3 py-2 text-left" value={settings.logoSize||56} onChange={e=>setSettings({...settings,logoSize:Number(e.target.value)||56})}/>
              </Field>
            </div>
            <div className="p-4 border-t text-sm text-slate-600">ÙŠÙØ­ÙØ¸ Ù…Ø±ÙƒØ²ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….</div>
          </div>
        </div>
      );
    }

    // ===== Projects: Payment Modal =====
    function PaymentModal({open,onClose,project,onSave,editing}){
      if(!open) return null;
      const [f,setF]=useState({
        date: editing?.date || todayISO(),
        amount: editing?.amount ?? "",
        settlementDate: editing?.settlementDate || "",
        fxManual: editing?.fxManual ?? "",
        type: editing?.type || "regular"
      });
      const set=(k,v)=>setF({...f,[k]:v});
      const valid=num(f.amount)>0;
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">{editing?"ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¯Ø§Ø¯":"Ø³Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯"} â€“ {project?.name||""}</h2>
              <button className="btn" onClick={onClose}>Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="Ø§Ù„ØªØ§Ø±ÙŠØ®"><input type="date" className="w-full border rounded-xl px-3 py-2" value={f.date} onChange={e=>set('date',e.target.value)}/></Field>
              <Field label={"Ø§Ù„Ù…Ø¨Ù„Øº ("+(project?.currency||"")+")"}><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={f.amount} onChange={e=>set('amount',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³ÙˆÙŠØ©"><input type="date" className="w-full border rounded-xl px-3 py-2" value={f.settlementDate} onChange={e=>set('settlementDate',e.target.value)}/></Field>
              {project?.currency!=="LYD" && (
                <Field label="FX ÙŠØ¯ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><input type="number" step="0.000001" className="w-full border rounded-xl px-3 py-2 text-left" value={f.fxManual} onChange={e=>set('fxManual',e.target.value)}/></Field>
              )}
              <Field label="Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¯Ø§Ø¯">
                <select className="w-full border rounded-xl px-3 py-2" value={f.type} onChange={e=>set('type',e.target.value)}>
                  <option value="regular">Ø¹Ø§Ø¯ÙŠ</option>
                  <option value="retention">Ø¶Ù…Ø§Ù†</option>
                </select>
              </Field>
            </div>
            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>Ø¥Ù„ØºØ§Ø¡</button>
              <button className="btn btn-primary" disabled={!valid} onClick={()=>onSave({
                date: f.date||todayISO(),
                amount: num(f.amount)||0,
                settlementDate: f.settlementDate||f.date||todayISO(),
                fxManual: (f.fxManual===""? null : Number(f.fxManual)),
                type: f.type
              })}>{editing? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¯Ø§Ø¯"}</button>
            </div>
          </div>
        </div>
      );
    }

    // ===== Projects: Project Modal (manual bid in LYD) =====
    function ProjectModal({open,onClose,initial,onSave}){
      if(!open) return null;
      const src=initial||{};
      const [form,setForm]=useState({
        name:src.name||"", client:src.client||"", supervisor:src.supervisor||"", po:src.po||"",
        currency:src.currency||"LYD",
        manualBidLYD: src.manualBidLYD ?? "",
        projectCostLYD: src.projectCostLYD ?? "",
        assignmentDate: src.assignmentDate || "", invoiceDate: src.invoiceDate || "", settlementDate: src.settlementDate || "",
        invoiceNumber: src.invoiceNumber || "", deliveryNoteNumber: src.deliveryNoteNumber || "",
        retentionAmount: src.retention?.amount ?? "", retentionStart: src.retention?.startDate || "", retentionRelease: src.retention?.releaseDate || ""
      });
      const set=(k,v)=>setForm({...form,[k]:v});
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between"><h2 className="text-lg font-bold">{initial?"ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹":"Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯"}</h2><button className="btn" onClick={onClose}>Ø¥ØºÙ„Ø§Ù‚</button></div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><input className="w-full border rounded-xl px-3 py-2" value={form.name} onChange={e=>set('name',e.target.value)}/></Field>
              <Field label="Ø§Ù„Ø¬Ù‡Ø©"><input className="w-full border rounded-xl px-3 py-2" value={form.client} onChange={e=>set('client',e.target.value)}/></Field>
              <Field label="Ø§Ù„Ù…Ø´Ø±Ù"><input className="w-full border rounded-xl px-3 py-2" value={form.supervisor} onChange={e=>set('supervisor',e.target.value)}/></Field>
              <Field label="Ø±Ù‚Ù… PO"><input className="w-full border rounded-xl px-3 py-2" value={form.po} onChange={e=>set('po',e.target.value)}/></Field>
              <Field label="Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><select className="w-full border rounded-xl px-3 py-2" value={form.currency} onChange={e=>set('currency',e.target.value)}>{CURRENCIES.map(c=><option key={c}>{c}</option>)}</select></Field>
              <Field label="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø·Ø§Ø¡ Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± (ÙŠØ¯ÙˆÙŠ)"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.manualBidLYD} onChange={e=>set('manualBidLYD',e.target.value)}/></Field>
              <Field label="ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (LYD)"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.projectCostLYD} onChange={e=>set('projectCostLYD',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙƒÙ„ÙŠÙ"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.assignmentDate} onChange={e=>set('assignmentDate',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.invoiceDate} onChange={e=>set('invoiceDate',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³ÙˆÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.settlementDate} onChange={e=>set('settlementDate',e.target.value)}/></Field>
              <Field label="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"><input className="w-full border rounded-xl px-3 py-2" value={form.invoiceNumber} onChange={e=>set('invoiceNumber',e.target.value)}/></Field>
              <Field label="Ø±Ù‚Ù… Ù…Ø­Ø¶Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…"><input className="w-full border rounded-xl px-3 py-2" value={form.deliveryNoteNumber} onChange={e=>set('deliveryNoteNumber',e.target.value)}/></Field>
              <Field label="Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø­ØªØ¬Ø²"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.retentionAmount} onChange={e=>set('retentionAmount',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¶Ù…Ø§Ù†"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.retentionStart} onChange={e=>set('retentionStart',e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø¶Ù…Ø§Ù†"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.retentionRelease} onChange={e=>set('retentionRelease',e.target.value)}/></Field>
            </div>
            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>Ø¥Ù„ØºØ§Ø¡</button>
              <button className="btn btn-primary" onClick={()=>{
                if(!form.name){ alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"); return; }
                onSave({
                  name:form.name, client:form.client||"", supervisor:form.supervisor||"", po:form.po||"",
                  currency:form.currency,
                  manualBidLYD: num(form.manualBidLYD)||0,
                  projectCostLYD: num(form.projectCostLYD)||0,
                  assignmentDate:form.assignmentDate||"", invoiceDate:form.invoiceDate||"", settlementDate:form.settlementDate||"",
                  invoiceNumber:form.invoiceNumber||"", deliveryNoteNumber:form.deliveryNoteNumber||"",
                  retention: (form.retentionAmount||form.retentionStart||form.retentionRelease)?{amount:num(form.retentionAmount)||0,startDate:form.retentionStart||"",releaseDate:form.retentionRelease||"",paid: initial?.retention?.paid||false}:null
                });
                onClose();
              }}>{initial?"Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"}</button>
            </div>
          </div>
        </div>
      );
    }

    // ===== Projects UI =====
    function ProjectsUI({projects,setProjects,auth}){
      const [filter,setFilter]=useState("ALL");
      const [search,setSearch]=useState("");
      const [projOpen,setProjOpen]=useState(false);
      const [projEditing,setProjEditing]=useState(null);
      const [payOpen,setPayOpen]=useState(false);
      const [payEditing,setPayEditing]=useState(null);
      const [payProject,setPayProject]=useState(null);
      const [expanded,setExpanded]=useState({});

      function toLYD(p, pay){
        if(p.currency==="LYD") return num(pay.amount);
        const r=pay.fxManual; if(r && r>0) return +(num(pay.amount)*r).toFixed(2);
        return null;
      }

      const rows=useMemo(()=> (projects||[]).map(p=>{
        const last=[...(p.payments||[])].sort((a,b)=>(a.date||"")<(b.date||"")?1:-1)[0];
        const inv=p.invoiceDate||"";
        const overdue=!last && inv && Math.round((new Date()-new Date(inv))/86400000) > 90;
        let rcvLYD=null;
        if(p.payments?.length){
          let s=0; p.payments.forEach(pay=>{
            const lyd = toLYD(p,pay);
            if(lyd!=null) s+=lyd;
          });
          rcvLYD=+s.toFixed(2);
        }
        const paid=!!last;
        const profit=(rcvLYD||0) - (Number(p.projectCostLYD||0));
        const margin=(rcvLYD && rcvLYD>0) ? +(100*profit/rcvLYD).toFixed(2) : null;
        const r=p.retention; const retentionDue=r && r.releaseDate && !r.paid && (new Date(r.releaseDate) <= new Date());
        return {...p, overdue, paid, totalLYDBid:(p.manualBidLYD??null), totalLYDReceived:rcvLYD, profitLYD:profit, marginPct:margin, retentionDue, lastPayDate:last?.date||null};
      }),[projects]);

      let filtered=rows;
      if(filter==="OVERDUE") filtered=filtered.filter(x=>x.overdue);
      if(filter==="PAID") filtered=filtered.filter(x=>x.paid);
      if(filter==="UNPAID") filtered=filtered.filter(x=>!x.paid);
      if(search.trim()){
        const q=search.trim().toLowerCase();
        filtered=filtered.filter(x=>[x.name,x.client,x.supervisor,x.po,x.invoiceNumber,x.deliveryNoteNumber].some(f=>(f||"").toLowerCase().includes(q)));
      }

      const totals=useMemo(()=>{const sum=(a,k)=>a.reduce((x,y)=>x+(y[k]||0),0);
        return {
          bid:+sum(rows.filter(x=>x.totalLYDBid!=null),"totalLYDBid").toFixed(2),
          rcv:+sum(rows.filter(x=>x.totalLYDReceived!=null),"totalLYDReceived").toFixed(2),
          profit:+sum(rows,"profitLYD").toFixed(2),
          unpaid: rows.filter(x=>!x.paid).length,
          delayed: rows.filter(x=>x.overdue).length
        };
      },[rows]);

      function exportCSV(){
        const headers=[
          {label:"ID",get:r=>r.id},
          {label:"Project",get:r=>r.name},
          {label:"Client",get:r=>r.client},
          {label:"Currency",get:r=>r.currency},
          {label:"Bid_LYD",get:r=>r.manualBidLYD},
          {label:"Received_LYD",get:r=>r.totalLYDReceived},
          {label:"Cost_LYD",get:r=>r.projectCostLYD},
          {label:"Profit_LYD",get:r=>r.profitLYD},
          {label:"InvoiceNo",get:r=>r.invoiceNumber||""},
          {label:"InvoiceDate",get:r=>r.invoiceDate||""},
          {label:"Status",get:r=>r.paid?"Paid":(r.overdue?"Overdue":"Unpaid")}
        ];
        downloadText(`projects-${todayISO()}.csv`, toCSV(rows,headers), "text/csv");
      }
      function exportJSON(){
        downloadText(`projects-${todayISO()}.json`, JSON.stringify(projects||[],null,2));
      }
      async function importJSON(){
        const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
        inp.onchange=async()=>{
          const f=inp.files[0]; if(!f) return;
          const text=await f.text();
          try{
            const data=JSON.parse(text);
            if(!Array.isArray(data)) throw new Error("JSON must be an array");
            if(!confirm("Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
            await kvPut("nwgd_projects", data);
            location.reload();
          }catch(e){ alert("Import failed: "+e.message); }
        };
        inp.click();
      }

      return (
        <div className="space-y-6">
          {rows.some(x=>x.retentionDue) && <div className="p-3 rounded-xl bg-amber-50 text-amber-900 text-sm">Ù„Ø¯ÙŠÙƒ Ù…Ø¨Ø§Ù„Øº Ø¶Ù…Ø§Ù† Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚.</div>}

          <section className="flex flex-wrap items-center gap-2">
            <input className="px-3 py-2 rounded-xl border bg-white w-72" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù…/Ø¬Ù‡Ø©/Ù…Ø´Ø±Ù/PO/ÙØ§ØªÙˆØ±Ø©/Ù…Ø­Ø¶Ø±" value={search} onChange={e=>setSearch(e.target.value)}/>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="ALL"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("ALL")}>Ø§Ù„ÙƒÙ„</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="OVERDUE"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("OVERDUE")}>Ù…ØªØ£Ø®Ø±</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="UNPAID"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("UNPAID")}>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="PAID"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("PAID")}>Ù…Ø¯ÙÙˆØ¹</button>
            <div className="ms-auto flex items-center gap-2">
              <button className="btn" onClick={exportCSV}>ØªØµØ¯ÙŠØ± CSV</button>
              <button className="btn" onClick={exportJSON}>ØªØµØ¯ÙŠØ± JSON</button>
              <button className="btn" onClick={importJSON}>Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
              <button className="btn btn-primary" onClick={()=>{ setProjEditing(null); setProjOpen(true); }}>+ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-3 table-wrap">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-semibold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
              <div className="text-sm text-slate-500 flex gap-4">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø·Ø§Ø¡ (LYD): <b className="tabular-nums">{totals.bid.toLocaleString()}</b></span>
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù… (LYD): <b className="tabular-nums">{totals.rcv.toLocaleString()}</b></span>
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (LYD): <b className="tabular-nums">{totals.profit.toLocaleString()}</b></span>
              </div>
            </div>
            <table className="min-w-full text-sm">
              <thead className="bg-white">
                <tr className="text-left border-b">
                  {["#","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","Ø§Ù„Ø¬Ù‡Ø©","Ø§Ù„Ù…Ø´Ø±Ù","PO","Ø§Ù„Ø¹Ù…Ù„Ø©","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø·Ø§Ø¡ (LYD)","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù… (LYD)","Ø§Ù„ØªÙƒÙ„ÙØ© (LYD)","Ø§Ù„Ø±Ø¨Ø­ (LYD)","% Ø§Ù„Ù‡Ø§Ù…Ø´","Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©","Ø±Ù‚Ù… Ù…Ø­Ø¶Ø±","Øª.Ø§Ù„ÙØ§ØªÙˆØ±Ø©","Ø¢Ø®Ø± Ø³Ø¯Ø§Ø¯","Ø§Ù„Ø­Ø§Ù„Ø©"].map(h=>{
                    const hide=(h==="Ø§Ù„Ù…Ø´Ø±Ù"||h==="PO"||h==="Ø§Ù„ØªÙƒÙ„ÙØ© (LYD)"||h==="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©"||h==="Ø±Ù‚Ù… Ù…Ø­Ø¶Ø±"||h==="Øª.Ø§Ù„ÙØ§ØªÙˆØ±Ø©"||h==="Ø¢Ø®Ø± Ø³Ø¯Ø§Ø¯")?"hidden lg:table-cell":"";
                    return <th key={h} className={classNames("py-2 px-2 whitespace-nowrap",hide)}>{h}</th>;
                  })}
                  <th className="py-2 px-2 whitespace-nowrap sticky-right">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                {(filtered||[]).map(p=>{
                  const isExp=!!expanded[p.id];
                  return (
                    <React.Fragment key={p.id}>
                      <tr className={classNames("border-b", p.overdue&&!p.paid?"bg-red-50":p.paid?"bg-emerald-50":"")}>
                        <td className="py-2 px-2">{p.id}</td>
                        <td className="py-2 px-2">{p.name}</td>
                        <td className="py-2 px-2">{p.client||"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.supervisor||"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.po||"â€”"}</td>
                        <td className="py-2 px-2">{p.currency}</td>
                        <td className="py-2 px-2 tabular-nums">{p.manualBidLYD!=null? Number(p.manualBidLYD).toLocaleString():"â€”"}</td>
                        <td className="py-2 px-2 tabular-nums">{p.totalLYDReceived!=null? p.totalLYDReceived.toLocaleString():"â€”"}</td>
                        <td className="py-2 px-2 tabular-nums hidden lg:table-cell">{(p.projectCostLYD!=null)? Number(p.projectCostLYD).toLocaleString():"â€”"}</td>
                        <td className="py-2 px-2 tabular-nums">{(p.profitLYD!=null)? p.profitLYD.toLocaleString():"â€”"}</td>
                        <td className="py-2 px-2">{p.marginPct!=null? p.marginPct+"%":"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.invoiceNumber||"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.deliveryNoteNumber||"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.invoiceDate||"â€”"}</td>
                        <td className="py-2 px-2 hidden lg:table-cell">{p.lastPayDate||"â€”"}</td>
                        <td className="py-2 px-2">{p.paid? "Ù…Ø¯ÙÙˆØ¹" : p.overdue? "Ù…ØªØ£Ø®Ø±" : "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"}</td>
                        <td className="py-2 px-2 sticky-right">
                          <div className="actions flex gap-1">
                            <button className="icon" title="ØªØ¹Ø¯ÙŠÙ„" onClick={()=>{ setProjEditing(p); setProjOpen(true); }}>âœï¸</button>
                            <button className="icon" title="Ø³Ø¯Ø§Ø¯" onClick={()=>{ setPayProject(p); setPayEditing(null); setPayOpen(true); }}>ğŸ’³</button>
                            <button className="icon" title={isExp?"Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„":"ØªÙØ§ØµÙŠÙ„"} onClick={()=>setExpanded({...expanded,[p.id]:!isExp})}>{isExp?"â–´":"â–¾"}</button>
                            <button className="icon" title="Ø­Ø°Ù" onClick={()=>{
                              if(auth.session?.role!=="admin"){ alert("ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø­Ø°Ù"); return; }
                              if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ")) setProjects((projects||[]).filter(x=>x.id!==p.id));
                            }}>ğŸ—‘ï¸</button>
                          </div>
                        </td>
                      </tr>
                      {isExp && (
                        <tr className="bg-slate-50">
                          <td colSpan="17" className="p-3">
                            <div className="flex items-center justify-between mb-2 gap-2">
                              <div className="font-semibold">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                              <div className="flex gap-2">
                                {p.retention?.releaseDate && !p.retention?.paid && (
                                  <button className="btn btn-warn" onClick={()=>{ setPayProject({...p,_retentionRelease:true}); setPayEditing(null); setPayOpen(true); }}>
                                    Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø¶Ù…Ø§Ù† ({p.retention.amount||0} {p.currency})
                                  </button>
                                )}
                                <button className="btn btn-primary" onClick={()=>{ setPayProject(p); setPayEditing(null); setPayOpen(true); }}>+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¯Ø§Ø¯</button>
                              </div>
                            </div>
                            <div className="overflow-auto">
                              <table className="min-w-full text-sm">
                                <thead><tr className="text-left border-b">{["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…Ø¨Ù„Øº ("+p.currency+")","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³ÙˆÙŠØ©","FX ÙŠØ¯ÙˆÙŠ","Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø±","Ø§Ù„Ù†ÙˆØ¹","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}</tr></thead>
                                <tbody>
                                  {(p.payments||[]).map(pay=>{
                                    const lyd = (p.currency==="LYD")? num(pay.amount) : (pay.fxManual? +(num(pay.amount)*pay.fxManual).toFixed(2) : null);
                                    return (
                                      <tr key={pay.id} className="border-b last:border-0">
                                        <td className="py-2 px-2">{pay.date||"â€”"}</td>
                                        <td className="py-2 px-2 tabular-nums">{num(pay.amount).toLocaleString()}</td>
                                        <td className="py-2 px-2">{pay.settlementDate||"â€”"}</td>
                                        <td className="py-2 px-2">{pay.fxManual ?? "â€”"}</td>
                                        <td className="py-2 px-2 tabular-nums">{lyd!=null? Number(lyd).toLocaleString():"â€”"}</td>
                                        <td className="py-2 px-2">{pay.type==="retention"?"Ø¶Ù…Ø§Ù†":"Ø¹Ø§Ø¯ÙŠ"}</td>
                                        <td className="py-2 px-2">
                                          <div className="actions flex gap-1">
                                            <button className="icon" title="ØªØ¹Ø¯ÙŠÙ„" onClick={()=>{ setPayProject(p); setPayEditing(pay); setPayOpen(true); }}>âœï¸</button>
                                            <button className="icon" title="Ø­Ø°Ù" onClick={()=>{
                                              if(auth.session?.role!=="admin"){ alert("ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø­Ø°Ù"); return; }
                                              setProjects((projects||[]).map(pr=>pr.id===p.id? {...pr, payments: (pr.payments||[]).filter(x=>x.id!==pay.id)} : pr));
                                            }}>ğŸ—‘ï¸</button>
                                          </div>
                                        </td>
                                      </tr>
                                    );
                                  })}
                                  {(!p.payments||p.payments.length===0) && <tr><td className="py-2 px-2 text-slate-500" colSpan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¨Ø¹Ø¯.</td></tr>}
                                </tbody>
                              </table>
                            </div>
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </section>

          <ProjectModal open={projOpen} onClose={()=>setProjOpen(false)} initial={projEditing} onSave={(patch)=>{
            if(projEditing){ const id=projEditing.id; setProjects((projects||[]).map(p=>p.id===id? {...p,...patch}:p)); }
            else{ const id=((projects||[]).at(-1)?.id||0)+1; setProjects([...(projects||[]), {id, payments:[], retention:patch.retention ?? null, ...patch}]); }
          }}/>
          <PaymentModal open={payOpen} onClose={()=>setPayOpen(false)} project={payProject} editing={payEditing} onSave={(pay)=>{
            if(!payProject) return;
            if(payProject._retentionRelease && !payEditing){
              setProjects((projects||[]).map(p=>p.id===payProject.id? {
                ...p, payments:[...(p.payments||[]), {...pay,id:`p${Date.now()}`,type:"retention"}],
                retention:{...(p.retention||{}), paid:true}
              } : p));
            }else if(payEditing){
              setProjects((projects||[]).map(p=>p.id===payProject.id? {
                ...p, payments:p.payments.map(x=>x.id===payEditing.id? {...payEditing,...pay}:x)
              } : p));
            }else{
              setProjects((projects||[]).map(p=>p.id===payProject.id? {...p, payments:[...(p.payments||[]), {...pay,id:`p${Date.now()}`}] } : p));
            }
            setPayOpen(false);
          }}/>
        </div>
      );
    }

    // ===== Tenders: Modal =====
    function TenderModal({open,onClose,initial,onSave}){
      if(!open) return null;
      const src=initial||{};
      const [form,setForm]=useState({
        title: src.title||"", client: src.client||"",
        submissionDate: src.submissionDate||"", dueDate: src.dueDate||"",
        financialOfferLYD: src.financialOfferLYD ?? "",
        technicalNotes: src.technicalNotes||"",
        status: src.status||"draft",
        files: src.files || []
      });
      const set=(k,v)=>setForm({...form,[k]:v});
      const addFile=()=>set("files",[...(form.files||[]), {id:"f"+Date.now(), name:"", url:"", type:"", note:""}]);
      const setFile=(i,k,v)=>{ const c=[...(form.files||[])]; c[i]={...c[i],[k]:v}; set("files",c); };
      const delFile=i=>{ const c=[...(form.files||[])]; c.splice(i,1); set("files",c); };
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between"><h2 className="text-lg font-bold">{initial?"ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø§Ù‚ØµØ©":"Ù…Ù†Ø§Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©"}</h2><button className="btn" onClick={onClose}>Ø¥ØºÙ„Ø§Ù‚</button></div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"><input className="w-full border rounded-xl px-3 py-2" value={form.title} onChange={e=>set("title",e.target.value)}/></Field>
              <Field label="Ø§Ù„Ø¬Ù‡Ø©"><input className="w-full border rounded-xl px-3 py-2" value={form.client} onChange={e=>set("client",e.target.value)}/></Field>
              <Field label="ØªØ§Ø±ÙŠØ® ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø·Ø§Ø¡"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.submissionDate} onChange={e=>set("submissionDate",e.target.value)}/></Field>
              <Field label="Ù…ÙˆØ¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.dueDate} onChange={e=>set("dueDate",e.target.value)}/></Field>
              <Field label="Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ù„ÙŠ (LYD)"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.financialOfferLYD} onChange={e=>set("financialOfferLYD",e.target.value)}/></Field>
              <Field label="Ø§Ù„Ø­Ø§Ù„Ø©">
                <select className="w-full border rounded-xl px-3 py-2" value={form.status} onChange={e=>set("status",e.target.value)}>
                  <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
                  <option value="submitted">ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</option>
                  <option value="won">Ø±Ø§Ø¨Ø­</option>
                  <option value="lost">Ø®Ø§Ø³Ø±</option>
                  <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                </select>
              </Field>
              <div className="md:col-span-2">
                <Field label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠ / Ø±ÙˆØ§Ø¨Ø·">
                  <textarea className="w-full border rounded-xl px-3 py-2" rows="3" value={form.technicalNotes} onChange={e=>set("technicalNotes",e.target.value)} />
                </Field>
              </div>

              <div className="md:col-span-2">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold">Ù…Ø±ÙÙ‚Ø§Øª (Ø±ÙˆØ§Ø¨Ø·)</div>
                  <button className="btn" onClick={addFile}>+ Ù…Ù„Ù</button>
                </div>
                <div className="space-y-2">
                  {(form.files||[]).map((f,i)=>(
                    <div key={f.id} className="grid md:grid-cols-4 gap-2">
                      <input className="border rounded-xl px-3 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù" value={f.name||""} onChange={e=>setFile(i,"name",e.target.value)}/>
                      <input className="border rounded-xl px-3 py-2" placeholder="Ø±Ø§Ø¨Ø· URL" value={f.url||""} onChange={e=>setFile(i,"url",e.target.value)}/>
                      <input className="border rounded-xl px-3 py-2" placeholder="Ø§Ù„Ù†ÙˆØ¹ (PDF/Word)" value={f.type||""} onChange={e=>setFile(i,"type",e.target.value)}/>
                      <div className="flex gap-2">
                        <input className="border rounded-xl px-3 py-2 flex-1" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" value={f.note||""} onChange={e=>setFile(i,"note",e.target.value)}/>
                        <button className="btn btn-danger" onClick={()=>delFile(i)}>Ø­Ø°Ù</button>
                      </div>
                    </div>
                  ))}
                  {(!form.files||form.files.length===0) && <div className="text-sm text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª.</div>}
                </div>
              </div>
            </div>
            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>Ø¥Ù„ØºØ§Ø¡</button>
              <button className="btn btn-primary" onClick={()=>{
                if(!form.title){ alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©/Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"); return; }
                onSave({
                  title:form.title, client:form.client||"",
                  submissionDate:form.submissionDate||"", dueDate:form.dueDate||"",
                  financialOfferLYD:num(form.financialOfferLYD)||0,
                  technicalNotes:form.technicalNotes||"",
                  status:form.status||"draft",
                  files:form.files||[]
                });
                onClose();
              }}>{initial?"Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©"}</button>
            </div>
          </div>
        </div>
      );
    }

    // ===== Tenders UI =====
    function TendersUI({tenders,setTenders,projects,setProjects,auth}){
      const [search,setSearch]=useState("");
      const [status,setStatus]=useState("ALL");
      const [open,setOpen]=useState(false);
      const [editing,setEditing]=useState(null);

      const rows=useMemo(()=>{
        let rs=[...(tenders||[])];
        if(search.trim()){
          const q=search.trim().toLowerCase();
          rs=rs.filter(t=>[t.title,t.client,t.technicalNotes].some(s=>String(s||"").toLowerCase().includes(q)));
        }
        if(status!=="ALL") rs=rs.filter(t=>t.status===status);
        return rs.sort((a,b)=>(a.id)-(b.id));
      },[tenders,search,status]);

      function exportCSV(){
        const headers=[
          {label:"ID",get:r=>r.id},
          {label:"Title",get:r=>r.title},
          {label:"Client",get:r=>r.client},
          {label:"SubmissionDate",get:r=>r.submissionDate||""},
          {label:"DueDate",get:r=>r.dueDate||""},
          {label:"OfferLYD",get:r=>r.financialOfferLYD},
          {label:"Status",get:r=>r.status}
        ];
        downloadText(`tenders-${todayISO()}.csv`, toCSV(rows,headers), "text/csv");
      }
      function exportJSON(){
        downloadText(`tenders-${todayISO()}.json`, JSON.stringify(tenders||[],null,2));
      }
      async function importJSON(){
        const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
        inp.onchange=async()=>{
          const f=inp.files[0]; if(!f) return;
          const text=await f.text();
          try{
            const data=JSON.parse(text);
            if(!Array.isArray(data)) throw new Error("JSON must be an array");
            if(!confirm("Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
            await kvPut("nwgd_tenders", data);
            location.reload();
          }catch(e){ alert("Import failed: "+e.message); }
        };
        inp.click();
      }

      function convertToProject(t){
        if(!confirm("ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© Ø¥Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹ØŸ")) return;
        const nextId = ((projects||[]).at(-1)?.id||0)+1;
        const proj = {
          id: nextId,
          name: t.title,
          client: t.client||"",
          supervisor: "",
          po: "",
          currency: "LYD",
          manualBidLYD: num(t.financialOfferLYD)||0,
          projectCostLYD: 0,
          assignmentDate: todayISO(),
          invoiceDate: "",
          settlementDate: "",
          invoiceNumber: "",
          deliveryNoteNumber: "",
          retention: null,
          payments: []
        };
        setProjects([...(projects||[]), proj]);
        // keep tender as won (no deletion)
        setTenders((tenders||[]).map(x=>x.id===t.id? {...x, status:"won"} : x));
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©.");
      }

      return (
        <div className="space-y-6">
          <section className="flex flex-wrap items-center gap-2">
            <input className="px-3 py-2 rounded-xl border bg-white w-72" placeholder="Ø¨Ø­Ø«: Ø§Ø³Ù…/Ø¬Ù‡Ø©/Ù…Ù„Ø§Ø­Ø¸Ø©" value={search} onChange={e=>setSearch(e.target.value)}/>
            <select className="px-3 py-2 rounded-xl border bg-white" value={status} onChange={e=>setStatus(e.target.value)}>
              <option value="ALL">Ø§Ù„ÙƒÙ„</option>
              <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
              <option value="submitted">ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</option>
              <option value="won">Ø±Ø§Ø¨Ø­</option>
              <option value="lost">Ø®Ø§Ø³Ø±</option>
              <option value="cancelled">Ù…Ù„ØºÙŠ</option>
            </select>
            <div className="ms-auto flex items-center gap-2">
              <button className="btn" onClick={exportCSV}>ØªØµØ¯ÙŠØ± CSV</button>
              <button className="btn" onClick={exportJSON}>ØªØµØ¯ÙŠØ± JSON</button>
              <button className="btn" onClick={importJSON}>Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
              <button className="btn btn-primary" onClick={()=>{ setEditing(null); setOpen(true); }}>+ Ù…Ù†Ø§Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-3 table-wrap">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-semibold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª</h2>
              <div className="text-sm text-slate-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b className="tabular-nums">{rows.length}</b></div>
            </div>
            <table className="min-w-full text-sm">
              <thead className="bg-white">
                <tr className="text-left border-b">
                  {["#","Ø§Ù„Ø¬Ù‡Ø©","Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…","Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…","Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ù„ÙŠ (LYD)","Ø§Ù„Ø­Ø§Ù„Ø©","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}
                </tr>
              </thead>
              <tbody>
                {rows.map(t=>(
                  <tr key={t.id} className="border-b last:border-0">
                    <td className="py-2 px-2">{t.id}</td>
                    <td className="py-2 px-2">{t.client||"â€”"}</td>
                    <td className="py-2 px-2">{t.title}</td>
                    <td className="py-2 px-2">{t.submissionDate||"â€”"}</td>
                    <td className="py-2 px-2">{t.dueDate||"â€”"}</td>
                    <td className="py-2 px-2 tabular-nums">{t.financialOfferLYD!=null? Number(t.financialOfferLYD).toLocaleString():"â€”"}</td>
                    <td className="py-2 px-2">{({draft:"Ù…Ø³ÙˆØ¯Ø©",submitted:"ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…",won:"Ø±Ø§Ø¨Ø­",lost:"Ø®Ø§Ø³Ø±",cancelled:"Ù…Ù„ØºÙŠ"})[t.status||"draft"]}</td>
                    <td className="py-2 px-2">
                      <div className="actions flex gap-1">
                        <button className="icon" title="ØªØ¹Ø¯ÙŠÙ„" onClick={()=>{ setEditing(t); setOpen(true); }}>âœï¸</button>
                        <button className="icon" title="ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø´Ø±ÙˆØ¹" onClick={()=>convertToProject(t)}>â†—ï¸</button>
                        <button className="icon" title="Ø­Ø°Ù" onClick={()=>{
                          if(auth.session?.role!=="admin"){ alert("ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø­Ø°Ù"); return; }
                          if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©ØŸ")) setTenders((tenders||[]).filter(x=>x.id!==t.id));
                        }}>ğŸ—‘ï¸</button>
                      </div>
                    </td>
                  </tr>
                ))}
                {rows.length===0 && <tr><td colSpan="8" className="py-4 px-2 text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ù‚ØµØ§Øª.</td></tr>}
              </tbody>
            </table>
          </section>

          <TenderModal open={open} onClose={()=>setOpen(false)} initial={editing} onSave={(patch)=>{
            if(editing){
              const id=editing.id;
              setTenders((tenders||[]).map(t=>t.id===id? {...t,...patch, updatedAt: new Date().toISOString() } : t));
            }else{
              const id=((tenders||[]).at(-1)?.id||0)+1;
              setTenders([...(tenders||[]), {id, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), ...patch}]);
            }
          }}/>
        </div>
      );
    }

    // ===== Main App =====
    function MainApp({auth}){
      const [settings,setSettings]=useSettings();
      const [projects,setProjects]=useServerState("nwgd_projects",[]);
      const [tenders,setTenders]=useServerState("nwgd_tenders",[]);
      const [tab,setTab]=useState("projects");
      const logoSrc=settings.logoUrl||""; const logoSize=settings.logoSize||56;

      // Totals for dashboard (projects only)
      const totals=useMemo(()=>{ 
        let B=0,S=0,P=0, unpaid=0, delayed=0, retCount=0, retSum=0;
        (projects||[]).forEach(p=>{
          const last=[...(p.payments||[])].sort((a,b)=>(a.date||"")<(b.date||"")?1:-1)[0];
          let s=0; (p.payments||[]).forEach(pay=>{
            const lyd=(p.currency==="LYD")? num(pay.amount) : (pay.fxManual? +(num(pay.amount)*pay.fxManual).toFixed(2) : null);
            if(lyd!=null) s+=lyd;
          });
          B+=(num(p.manualBidLYD)||0); S+=s; P+=(s - (Number(p.projectCostLYD||0)));
          const hasPayment=!!last;
          if(!hasPayment) unpaid++;
          const inv=p.invoiceDate||"";
          if(!hasPayment && inv && Math.round((new Date()-new Date(inv))/86400000) > 90) delayed++;
          if(p.retention && !p.retention.paid){
            retCount++; retSum += Number(p.retention.amount||0) * (p.currency==="LYD"?1:(1)); // no FX table
          }
        });
        return {B:+B.toFixed(2), S:+S.toFixed(2), P:+P.toFixed(2), unpaidCount:unpaid, delayedCount:delayed, retentionCount:retCount, retentionSum:+retSum.toFixed(2)};
      },[projects]);

      // Export/Import BOTH datasets (backup/restore)
      async function backupAll(){
        const data={
          projects: await kvGet("nwgd_projects").catch(()=>projects||[]),
          tenders: await kvGet("nwgd_tenders").catch(()=>tenders||[]),
          settings: await kvGet("nwgd_settings").catch(()=>settings||{}),
          users: await kvGet("nwgd_users").catch(()=>[])
        };
        downloadText(`backup-${todayISO()}.json`, JSON.stringify(data,null,2));
      }
      async function restoreAll(){
        const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
        inp.onchange=async()=>{
          const f=inp.files[0]; if(!f) return;
          const text=await f.text();
          try{
            const data=JSON.parse(text);
            if(!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø´Ø§Ø±ÙŠØ¹ + Ù…Ù†Ø§Ù‚ØµØ§Øª + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
            if(data.projects) await kvPut("nwgd_projects", data.projects);
            if(data.tenders) await kvPut("nwgd_tenders", data.tenders);
            if(data.settings) await kvPut("nwgd_settings", data.settings);
            location.reload();
          }catch(e){ alert("Restore failed: "+e.message); }
        };
        inp.click();
      }

      return (
        <div className="max-w-7xl mx-auto p-4 space-y-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {logoSrc ? <img src={logoSrc} className="object-contain" style={{height:logoSize+"px"}}/> : <div className="h-12 w-12 bg-slate-200 rounded"></div>}
              <div className="text-xl font-bold">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
              <span className="text-xs px-2 py-1 rounded bg-slate-200">ÙˆØ¶Ø¹: Ø®Ø§Ø¯Ù… Ù…Ø´ØªØ±Ùƒ</span>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={backupAll}>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
              <button className="btn" onClick={restoreAll}>Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
              <button className="btn" onClick={()=>setTab("tenders")} disabled={tab==="tenders"}>Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª</button>
              <button className="btn" onClick={()=>setTab("projects")} disabled={tab==="projects"}>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
              <button className="btn" onClick={()=>window.__openSettings?.()}>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
              <span className="text-sm text-slate-600">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ {auth.session.username}</span>
              <button className="btn btn-danger" onClick={auth.logout}>Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>

          {tab==="projects" && (
            <>
              {totals.retentionCount>0 && (
                <div className="p-3 rounded-xl bg-amber-100 text-amber-900 text-sm border border-amber-300">
                  ÙŠÙˆØ¬Ø¯ <b>{totals.retentionCount}</b> Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù‡ <b>Ù…Ø¨Ù„Øº Ø¶Ù…Ø§Ù† Ù…Ø­ØªØ¬Ø²</b> ØºÙŠØ± Ù…ÙØ·Ù„Ù‚. Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ù…Ø§Ù† (LYD): <b className="tabular-nums">{totals.retentionSum.toLocaleString()}</b>.
                </div>
              )}

              <div className="grid md:grid-cols-5 gap-3">
                <Card title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø·Ø§Ø¡ (LYD)" value={totals.B}/>
                <Card title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù… (LYD)" value={totals.S}/>
                <Card title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ (LYD)" value={totals.P}/>
                <Card title="Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©" value={totals.unpaidCount}/>
                <Card title="Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (>90ÙŠÙˆÙ…)" value={totals.delayedCount}/>
              </div>

              <ProjectsUI projects={projects} setProjects={setProjects} auth={auth} />
            </>
          )}

          {tab==="tenders" && (
            <TendersUI tenders={tenders} setTenders={setTenders} projects={projects} setProjects={setProjects} auth={auth} />
          )}

          <SettingsPortal settings={settings} setSettings={setSettings}/>
        </div>
      );
    }

    // simple portal-less settings opener
    function SettingsPortal({settings,setSettings}){
      const [open,setOpen]=useState(false);
      useEffect(()=>{ window.__openSettings=()=>setOpen(true); },[]);
      return <SettingsModal open={open} onClose={()=>setOpen(false)} settings={settings} setSettings={setSettings}/>;
    }

    // ===== Login with logo from settings =====
    function Login({onLogin}){
      const [u,setU]=useState("admin"), [p,setP]=useState("admin123"), [msg,setMsg]=useState("");
      const [logo,setLogo]=useState({url:"",size:56});
      useEffect(()=>{(async()=>{
        try{
          const s=await kvGet("nwgd_settings");
          setLogo({url:s?.logoUrl||"", size:s?.logoSize||56});
        }catch(e){}
      })()},[]);
      async function submit(e){ e.preventDefault(); const r=await onLogin(u,p); if(!r.ok) setMsg(r.msg); }
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="w-[420px] max-w-[95vw] space-y-6">
            <div className="text-center space-y-3">
              {logo.url ? <img src={logo.url} className="mx-auto object-contain" style={{height:(logo.size||56)+"px"}}/> :
                <div className="mx-auto h-16 w-16 rounded-full bg-slate-200 flex items-center justify-center font-bold">NW</div>}
              <div className="text-2xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            </div>
            <form onSubmit={submit} className="bg-white rounded-2xl shadow p-4 space-y-3">
              <Field label="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><input className="w-full border rounded-xl px-3 py-2" value={u} onChange={(e)=>setU(e.target.value)} required/></Field>
              <Field label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><input type="password" className="w-full border rounded-xl px-3 py-2" value={p} onChange={(e)=>setP(e.target.value)} required/></Field>
              {msg && <div className="text-rose-600 text-sm">{msg}</div>}
              <button type="submit" className="w-full btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <div className="text-center text-xs text-slate-500">Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø´ØªØ±Ùƒ â€” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø±ÙƒØ²ÙŠÙ‹Ø§</div>
          </div>
        </div>
      );
    }

    // ===== Shell =====
    function Shell(){
      const auth=useAuth();
      if(!auth.booted) return <div className="p-6">...</div>;
      if(!auth.session) return <Login onLogin={auth.login}/>;
      return <MainApp auth={auth}/>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Shell/>);
  </script>
</body>
</html>
