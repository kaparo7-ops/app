<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>إدارة المناقصات – Nawafed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .tabular-nums{font-variant-numeric:tabular-nums}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100}
    .panel{width:900px;max-width:95vw;max-height:90vh;overflow:auto;background:#fff;border-radius:1rem;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .btn{padding:.45rem .7rem;border-radius:.65rem;border:1px solid #e2e8f0;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .btn-warn{background:#b45309;color:#fff;border-color:#b45309}
    .btn-danger{background:#e11d48;color:#fff;border-color:#e11d48}
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- Error overlay (مفيد لو ظهر خطأ) -->
  <script>
    (function(){
      if(window.__errOverlayInstalled) return; window.__errOverlayInstalled = true;
      function show(msg){
        const d=document.createElement("div");
        d.style.position="fixed"; d.style.inset="0"; d.style.zIndex=99999; d.style.background="rgba(0,0,0,.85)";
        d.innerHTML='<div style="max-width:1000px;margin:24px auto;background:#111;color:#fff;border-radius:12px;padding:16px"><h2 style="margin:0 0 8px">JavaScript Error</h2><pre>'+msg+'</pre></div>';
        document.body.appendChild(d);
      }
      window.addEventListener("error", e=>show((e.error&&e.error.stack)||e.message||String(e)));
      window.addEventListener("unhandledrejection", e=>{const r=e.reason; show("Unhandled promise rejection:\n"+((r&&(r.stack||r.message))||String(r)));});
    })();
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useMemo,useRef} = React;

    // ===== إعدادات الخادم (استبدل التوكن) =====
    const FORCED_SERVER = { base:"/api", token:"PASTE_YOUR_SYNC_TOKEN_HERE" };

    // ===== أدوات تخزين (KV) =====
    async function kvGet(key){
      const r = await fetch(`${FORCED_SERVER.base}/kv/${encodeURIComponent(key)}?token=${FORCED_SERVER.token}`);
      if(!r.ok) throw new Error("kv get failed: "+r.status);
      return (await r.json()).value;
    }
    async function kvPut(key,value){
      const r = await fetch(`${FORCED_SERVER.base}/kv/${encodeURIComponent(key)}?token=${FORCED_SERVER.token}`,{
        method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({value})
      });
      if(!r.ok) throw new Error("kv put failed: "+r.status);
    }
    function useServerState(key, initial){
      const [state,setState]=useState(initial);
      const bootRef=useRef(false);
      useEffect(()=>{(async()=>{
        const remote=await kvGet(key).catch(()=>null);
        if(remote==null){ setState(initial); await kvPut(key, initial); }
        else setState(remote);
        bootRef.current=true;
      })()},[key]);
      const save=v=>{ setState(v); kvPut(key,v).catch(e=>{throw e}); };
      return [state, save, bootRef];
    }

    // ===== نماذج/ثوابت =====
    const CURRENCIES = ["LYD","USD","EUR"];
    const STATUS = ["قيد التجهيز","تم تأكيد المشاركة","مقدَّم","فائز","خاسر","معلق","ملغى"];
    const todayISO=()=>new Date().toISOString().slice(0,10);
    const num=v=>{const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?0:n};
    const classNames=(...xs)=>xs.filter(Boolean).join(" ");

    // ===== مكونات UI بسيطة =====
    function Field({label,children,help}){ return (
      <label className="space-y-1 block">
        <div className="text-sm text-slate-600">{label} {help && <span className="text-xs text-slate-400">— {help}</span>}</div>
        {children}
      </label>
    );}
    function Card({title,value}){ return <div className="bg-white rounded-2xl shadow p-4">
      <div className="text-sm text-slate-500">{title}</div>
      <div className="text-2xl font-bold mt-1 tabular-nums">{(value??0).toLocaleString? (value??0).toLocaleString(): String(value??"")}</div>
    </div>; }

    // ===== نافذة التفاصيل/التعديل + رفع الملفات =====
    function TenderModal({open,onClose,initial,onSave,loadFiles,saveFiles,removeFile}){
      if(!open) return null;
      const src=initial||{};
      const [form,setForm]=useState({
        ref:src.ref||"", name:src.name||"", type:src.type||"", client:src.client||"", person:src.person||"",
        end:src.end||"", visitDate:src.visitDate||"", notes:src.notes||"",
        confirm: src.status==="تم تأكيد المشاركة" || src.status==="مقدَّم" || src.status==="فائز",
        submitDate: src.submitDate||"",
        bidValue: src.bidValue??"",
        bidCurrency: src.bidCurrency||"LYD",
      });
      const [files,setFiles]=useState({tech:[], fin:[]}); // {name,size,type,dataUrl}

      useEffect(()=>{(async()=>{
        const f=await loadFiles(src.id);
        if(f) setFiles({tech:f.tech||[], fin:f.fin||[]});
      })()},[src.id]);

      const set=(k,v)=>setForm({...form,[k]:v});

      async function handleUpload(kind, fileList){
        const maxSize=12*1024*1024; // 12MB
        const arr=[...fileList];
        for(const file of arr){
          if(file.size>maxSize){ alert(`الملف ${file.name} يتجاوز 12MB`); continue; }
          const dataUrl=await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); });
          setFiles(prev=>({...prev,[kind]:[...prev[kind], {name:file.name,size:file.size,type:file.type,dataUrl}]}));
        }
      }

      async function saveAll(){
        const base = {
          ref:form.ref, name:form.name, type:form.type, client:form.client, person:form.person,
          end:form.end, visitDate:form.visitDate, notes:form.notes
        };
        let status = src.status || "قيد التجهيز";
        if(form.confirm) status = "تم تأكيد المشاركة";
        const patch = {...base, status};

        if(form.confirm){
          patch.submitDate = form.submitDate || "";
          patch.bidValue = num(form.bidValue)||0;
          patch.bidCurrency = form.bidCurrency || "LYD";
          // لو تم إدخال submitDate و bidValue نقدر نخلي الحالة "مقدَّم" مباشرة (اختياري)
          if(patch.submitDate) patch.status = "مقدَّم";
        }
        await onSave(patch); // يحفظ كائن المناقصة

        // حفظ الملفات
        await saveFiles(src.id, files);
        onClose();
      }

      function FileList({title,kind}){
        const arr=files[kind]||[];
        return (
          <div className="border rounded-xl">
            <div className="px-3 py-2 border-b font-medium">{title}</div>
            <div className="p-3 space-y-2">
              <input type="file" multiple onChange={(e)=>handleUpload(kind, e.target.files)}/>
              <div className="text-xs text-slate-500">الحد الأقصى ~12MB للملف.</div>
              <ul className="space-y-1">
                {arr.map((f,i)=>(
                  <li key={i} className="flex items-center justify-between bg-slate-50 rounded px-2 py-1">
                    <a className="text-blue-700 underline" href={f.dataUrl} download={f.name} target="_blank" rel="noreferrer">{f.name}</a>
                    <button className="btn btn-danger" onClick={()=>setFiles(prev=>({...prev,[kind]: prev[kind].filter((_,ix)=>ix!==i)}))}>حذف</button>
                  </li>
                ))}
                {arr.length===0 && <li className="text-slate-500">لا توجد ملفات.</li>}
              </ul>
            </div>
          </div>
        );
      }

      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">{src.id? "تفاصيل المناقصة":"إضافة مناقصة"}</h2>
              <button className="btn" onClick={onClose}>إغلاق</button>
            </div>

            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="الرقم المرجعي"><input className="w-full border rounded-xl px-3 py-2" value={form.ref} onChange={e=>set('ref',e.target.value)}/></Field>
              <Field label="اسم المشروع / المناقصة"><input className="w-full border rounded-xl px-3 py-2" value={form.name} onChange={e=>set('name',e.target.value)}/></Field>
              <Field label="نوع المناقصة"><input className="w-full border rounded-xl px-3 py-2" value={form.type} onChange={e=>set('type',e.target.value)}/></Field>
              <Field label="اسم الجهة"><input className="w-full border rounded-xl px-3 py-2" value={form.client} onChange={e=>set('client',e.target.value)}/></Field>
              <Field label="الشخص المكلَّف"><input className="w-full border rounded-xl px-3 py-2" value={form.person} onChange={e=>set('person',e.target.value)}/></Field>
              <Field label="تاريخ انتهاء التقديم"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.end} onChange={e=>set('end',e.target.value)}/></Field>
              <Field label="موعد الزيارة (اختياري)"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.visitDate} onChange={e=>set('visitDate',e.target.value)}/></Field>
              <Field label="ملاحظات"><textarea rows="3" className="w-full border rounded-xl px-3 py-2" value={form.notes} onChange={e=>set('notes',e.target.value)}></textarea></Field>
            </div>

            <div className="p-4 border-t">
              <label className="inline-flex items-center gap-2">
                <input type="checkbox" checked={form.confirm} onChange={e=>set('confirm',e.target.checked)}/>
                <span className="font-medium">تأكيد المشاركة</span>
              </label>
              {form.confirm && (
                <div className="grid md:grid-cols-3 gap-3 mt-3">
                  <Field label="تاريخ تقديم العرض"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.submitDate} onChange={e=>set('submitDate',e.target.value)}/></Field>
                  <Field label="قيمة العطاء"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.bidValue} onChange={e=>set('bidValue',e.target.value)}/></Field>
                  <Field label="العملة"><select className="w-full border rounded-xl px-3 py-2" value={form.bidCurrency} onChange={e=>set('bidCurrency',e.target.value)}>{CURRENCIES.map(c=><option key={c}>{c}</option>)}</select></Field>

                  <div className="md:col-span-3 grid md:grid-cols-2 gap-3">
                    <FileList title="العرض الفني" kind="tech"/>
                    <FileList title="العرض المالي" kind="fin"/>
                  </div>
                </div>
              )}
            </div>

            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>إلغاء</button>
              <button className="btn btn-primary" onClick={saveAll}>حفظ</button>
            </div>
          </div>
        </div>
      );
    }

    // ===== التطبيق =====
    function App(){
      const [tenders,setTenders] = useServerState("nwgd_tenders", []);
      const [tab,setTab] = useState("list");
      const [modal,setModal] = useState(false);
      const [editing,setEditing] = useState(null);
      const [search,setSearch] = useState("");
      const [perPage,setPerPage] = useState(25);
      const [page,setPage] = useState(1);

      function addBlank(){
        const id=Date.now();
        const t=[...tenders, {id, ref:"", name:"", type:"", client:"", person:"", end:"", visitDate:"", notes:"", status:"قيد التجهيز"}];
        setTenders(t);
        setEditing(t.find(x=>x.id===id));
        setModal(true);
      }
      function updateTender(id, patch){
        setTenders((tenders||[]).map(t=>t.id===id? {...t,...patch}:t));
      }
      function removeTender(id){
        if(!confirm("حذف المناقصة؟")) return;
        setTenders((tenders||[]).filter(t=>t.id!==id));
        kvPut(`nwgd_tender_files_${id}`, null).catch(()=>{});
      }

      // ملفات كل مناقصة (تخزين منفصل)
      async function loadFiles(id){
        if(!id) return null;
        const f = await kvGet(`nwgd_tender_files_${id}`).catch(()=>null);
        return f || {tech:[], fin:[]};
      }
      async function saveFiles(id, filesObj){
        if(!id) return;
        await kvPut(`nwgd_tender_files_${id}`, filesObj||{tech:[], fin:[]});
      }
      async function removeFile(id, kind, index){
        const f = await loadFiles(id);
        if(!f) return;
        f[kind] = (f[kind]||[]).filter((_,i)=>i!==index);
        await saveFiles(id, f);
      }

      // تصفية + ترقيم صفحات
      const filtered = useMemo(()=>{
        const q=search.trim().toLowerCase();
        let arr=[...(tenders||[])];
        if(q) arr=arr.filter(t=>[t.ref,t.name,t.client,t.type,t.person].some(v=>(v||"").toLowerCase().includes(q)));
        return arr.sort((a,b)=>String(b.end||"") < String(a.end||"") ? -1 : 1);
      },[tenders,search]);
      const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
      const safePage = Math.min(page, totalPages);
      const paged = filtered.slice((safePage-1)*perPage, safePage*perPage);

      // KPIs
      const kpi = useMemo(()=>{
        const total=tenders.length;
        const c = s => tenders.filter(x=>x.status===s).length;
        const prepared=c("قيد التجهيز");
        const confirmed=c("تم تأكيد المشاركة");
        const submitted=c("مقدَّم");
        const won=c("فائز");
        const lost=c("خاسر");
        const pending=c("معلق");
        const canceled=c("ملغى");
        const participating = confirmed + submitted;
        // قرب انتهاء التقديم ≤ 30 يوم
        const now=new Date();
        const nearing=tenders.filter(t=>t.end && ((new Date(t.end)-now)/(1000*60*60*24))<=30).length;
        const visits=tenders.filter(t=>t.visitDate).length;
        return {total,prepared,participating,won,lost,pending,canceled,nearing,visits};
      },[tenders]);

      // تنبيهات مرئية داخل الصفحة
      const now = new Date();
      const alerts = useMemo(()=>{
        const A=[];
        const soon = tenders.filter(t=>{
          if(!t.end) return false;
          const days=(new Date(t.end)-now)/(1000*60*60*24);
          return days<=7 && days>=0;
        });
        if(soon.length) A.push(`لديك ${soon.length} مناقصة تنتهي خلال 7 أيام.`);
        const vSoon = tenders.filter(t=>{
          if(!t.visitDate) return false;
          const days=(new Date(t.visitDate)-now)/(1000*60*60*24);
          return days<=7 && days>=0;
        });
        if(vSoon.length) A.push(`هناك ${vSoon.length} زيارة ميدانية خلال 7 أيام.`);
        return A;
      },[tenders]);

      // تصدير/استيراد
      function exportJSON(){
        const blob=new Blob([JSON.stringify(tenders,null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tenders.json"; a.click();
      }
      function exportCSV(){
        const header="id,ref,name,type,client,person,end,visitDate,status,submitDate,bidValue,bidCurrency,notes\n";
        const rows=(tenders||[]).map(t=>[
          t.id, JSON.stringify(t.ref||""), JSON.stringify(t.name||""), JSON.stringify(t.type||""),
          JSON.stringify(t.client||""), JSON.stringify(t.person||""), t.end||"", t.visitDate||"", t.status||"",
          t.submitDate||"", (t.bidValue??""), (t.bidCurrency||""), JSON.stringify(t.notes||"")
        ].join(","));
        const blob=new Blob([header+rows.join("\n")],{type:"text/csv"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tenders.csv"; a.click();
      }
      async function importJSONFile(file){
        const txt = await file.text();
        let arr=[]; try{ arr=JSON.parse(txt)||[]; }catch(e){ alert("ملف JSON غير صالح"); return; }
        if(!Array.isArray(arr)){ alert("JSON يجب أن يكون مصفوفة"); return; }
        // دمج بسيط (حسب id)
        const byId=new Map((tenders||[]).map(t=>[t.id,t]));
        arr.forEach(t=>{ if(t && t.id) byId.set(t.id,{...byId.get(t.id),...t}); });
        const merged=[...byId.values()];
        setTenders(merged);
      }

      return (
        <div className="max-w-7xl mx-auto p-4 space-y-6">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-bold">إدارة المناقصات</h1>
            <div className="flex gap-2">
              <a href="/index.html" className="btn">← المشاريع</a>
              <button className={classNames("btn", tab==="list"?"btn-primary":"")} onClick={()=>setTab("list")}>القائمة</button>
              <button className={classNames("btn", tab==="reports"?"btn-primary":"")} onClick={()=>setTab("reports")}>التقارير</button>
            </div>
          </div>

          {/* تنبيهات */}
          {alerts.map((m,i)=><div key={i} className="p-3 rounded-xl bg-amber-100 text-amber-900 border border-amber-300">{m}</div>)}

          {/* بطاقات إحصائية */}
          <div className="grid md:grid-cols-4 lg:grid-cols-6 gap-3">
            <Card title="إجمالي المناقصات" value={kpi.total}/>
            <Card title="قيد التجهيز" value={kpi.prepared}/>
            <Card title="المشاركة/مقدَّم" value={kpi.participating}/>
            <Card title="فائزة" value={kpi.won}/>
            <Card title="خاسرة" value={kpi.lost}/>
            <Card title="معلّقة" value={kpi.pending}/>
            <Card title="ملغاة" value={kpi.canceled}/>
            <Card title="قرب انتهاء التقديم (≤30يوم)" value={kpi.nearing}/>
            <Card title="زيارات قادمة" value={kpi.visits}/>
          </div>

          {/* تبويب القائمة */}
          {tab==="list" && (
            <div className="space-y-3">
              <div className="flex flex-wrap items-center gap-2">
                <input className="px-3 py-2 rounded-xl border bg-white w-72" placeholder="بحث: المرجع/الاسم/الجهة/النوع/الشخص" value={search} onChange={e=>{setSearch(e.target.value); setPage(1);}}/>
                <label className="text-sm text-slate-600 flex items-center gap-2">
                  لكل صفحة:
                  <select className="border rounded-xl px-2 py-1" value={perPage} onChange={e=>{setPerPage(Number(e.target.value)); setPage(1);}}>
                    {[25,50,100].map(n=><option key={n} value={n}>{n}</option>)}
                  </select>
                </label>
                <button className="btn btn-primary ms-auto" onClick={addBlank}>+ إضافة مناقصة</button>
              </div>

              <div className="bg-white rounded-2xl shadow overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left border-b">
                      {["#","المرجع","اسم المناقصة","النوع","الجهة","الشخص","انتهاء التقديم","الزيارة","الحالة","إجراءات"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {paged.map((t,idx)=>(
                      <tr key={t.id} className="border-b">
                        <td className="py-2 px-2">{(safePage-1)*perPage + idx + 1}</td>
                        <td className="py-2 px-2">{t.ref||"—"}</td>
                        <td className="py-2 px-2">{t.name||"—"}</td>
                        <td className="py-2 px-2">{t.type||"—"}</td>
                        <td className="py-2 px-2">{t.client||"—"}</td>
                        <td className="py-2 px-2">{t.person||"—"}</td>
                        <td className="py-2 px-2">{t.end||"—"}</td>
                        <td className="py-2 px-2">{t.visitDate||"—"}</td>
                        <td className="py-2 px-2">{t.status||"—"}</td>
                        <td className="py-2 px-2 space-x-2 space-x-reverse">
                          <button className="btn btn-primary" onClick={()=>{ setEditing(t); setModal(true); }}>تفاصيل</button>
                          <button className="btn btn-danger" onClick={()=>removeTender(t.id)}>حذف</button>
                        </td>
                      </tr>
                    ))}
                    {paged.length===0 && <tr><td className="py-3 px-2 text-slate-500 text-center" colSpan="10">لا توجد بيانات</td></tr>}
                  </tbody>
                </table>

                {/* ترقيم الصفحات */}
                <div className="flex items-center justify-between p-3 text-sm">
                  <div>الصفحة <b>{safePage}</b> من <b>{totalPages}</b> — إجمالي العناصر: <b>{filtered.length}</b></div>
                  <div className="flex items-center gap-2">
                    <button className="btn" disabled={safePage===1} onClick={()=>setPage(1)}>الأولى</button>
                    <button className="btn" disabled={safePage===1} onClick={()=>setPage(p=>Math.max(1,p-1))}>السابق</button>
                    <button className="btn" disabled={safePage===totalPages} onClick={()=>setPage(p=>Math.min(totalPages,p+1))}>التالي</button>
                    <button className="btn" disabled={safePage===totalPages} onClick={()=>setPage(totalPages)}>الأخيرة</button>
                  </div>
                </div>
              </div>

              {/* تصدير/استيراد */}
              <div className="flex items-center gap-2">
                <button className="btn" onClick={exportCSV}>تصدير CSV</button>
                <button className="btn" onClick={exportJSON}>تصدير JSON</button>
                <label className="btn">
                  استيراد JSON
                  <input type="file" accept="application/json" className="hidden" onChange={e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); e.target.value=""; }}/>
                </label>
              </div>
            </div>
          )}

          {/* تبويب التقارير */}
          {tab==="reports" && (
            <div className="space-y-6">
              <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-3">
                <Card title="إجمالي المناقصات" value={kpi.total}/>
                <Card title="قيد التجهيز" value={kpi.prepared}/>
                <Card title="المشاركة/مقدَّم" value={kpi.participating}/>
                <Card title="فائزة" value={kpi.won}/>
                <Card title="خاسرة" value={kpi.lost}/>
                <Card title="معلّقة" value={kpi.pending}/>
                <Card title="ملغاة" value={kpi.canceled}/>
                <Card title="قرب انتهاء (≤30يوم)" value={kpi.nearing}/>
                <Card title="زيارات قادمة" value={kpi.visits}/>
              </div>

              {/* الاستحقاقات القادمة */}
              <div className="bg-white rounded-2xl shadow overflow-auto">
                <div className="p-3 font-semibold">الاستحقاقات القادمة (≤30 يوم)</div>
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left border-b">
                      {["المرجع","اسم المناقصة","الجهة","انتهاء التقديم","الحالة"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {tenders.filter(t=>{
                      if(!t.end) return false;
                      const days=(new Date(t.end)-new Date())/(1000*60*60*24);
                      return days<=30;
                    }).map(t=>(
                      <tr key={t.id} className="border-b">
                        <td className="py-2 px-2">{t.ref||"—"}</td>
                        <td className="py-2 px-2">{t.name||"—"}</td>
                        <td className="py-2 px-2">{t.client||"—"}</td>
                        <td className="py-2 px-2">{t.end||"—"}</td>
                        <td className="py-2 px-2">{t.status||"—"}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* الزيارات */}
              <div className="bg-white rounded-2xl shadow overflow-auto">
                <div className="p-3 font-semibold">الزيارات الميدانية</div>
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left border-b">
                      {["المرجع","اسم المناقصة","المسؤول","تاريخ الزيارة","الحالة"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {tenders.filter(t=>t.visitDate).map(t=>(
                      <tr key={t.id} className="border-b">
                        <td className="py-2 px-2">{t.ref||"—"}</td>
                        <td className="py-2 px-2">{t.name||"—"}</td>
                        <td className="py-2 px-2">{t.person||"—"}</td>
                        <td className="py-2 px-2">{t.visitDate||"—"}</td>
                        <td className="py-2 px-2">{t.status||"—"}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="flex items-center gap-2">
                <button className="btn" onClick={()=>{
                  const blob=new Blob([JSON.stringify(tenders,null,2)],{type:"application/json"});
                  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tenders-report.json"; a.click();
                }}>تصدير JSON</button>
                <button className="btn" onClick={()=>window.print()}>طباعة / PDF</button>
              </div>
            </div>
          )}

          <TenderModal
            open={modal}
            onClose={()=>setModal(false)}
            initial={editing||{}}
            onSave={async (patch)=>{ if(!editing?.id) return; updateTender(editing.id, patch); }}
            loadFiles={loadFiles}
            saveFiles={saveFiles}
            removeFile={removeFile}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>

