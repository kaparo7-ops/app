<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>نظام متابعة المشاريع – Nawafed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .tabular-nums{font-variant-numeric:tabular-nums}
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}
    .panel{width:880px;max-width:95vw;max-height:90vh;overflow:auto;background:#fff;border-radius:1rem;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .btn{padding:.5rem .75rem;border-radius:.75rem;border:1px solid #e2e8f0;background:#fff}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .btn-warn{background:#b45309;color:#fff;border-color:#b45309}
    .btn-danger{background:#e11d48;color:#fff;border-color:#e11d48}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useMemo,useRef} = React;

    // ----------- Utils -----------
    const todayISO=()=>new Date().toISOString().slice(0,10);
    const num=v=>{const n=Number(String(v).replace(/[^0-9.\-]/g,''));return isNaN(n)?0:n};
    const toISO=v=>{if(!v)return"";try{const d=new Date(v);if(!isNaN(d))return d.toISOString().slice(0,10)}catch{}return""};
    const isISO=s=>/\d{4}-\d{2}-\d{2}/.test(String(s));
    const classNames=(...xs)=>xs.filter(Boolean).join(" ");
    const debounce=(fn,ms=300)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
    const LS_USERS="nwgd_users",LS_SESSION="nwgd_session",LS_AUTH_FAILS="nwgd_auth_fails";
    const LS_PROJECTS="nwgd_projects",LS_FX="nwgd_fx",LS_BOOT="nwgd_boot",LS_SETTINGS="nwgd_settings",LS_SYNC="nwgd_sync";

    // ----------- Server Sync (shared across browsers) -----------
    function useSyncConfig(){
      const [cfg,setCfg]=useState(()=>{try{return JSON.parse(localStorage.getItem(LS_SYNC)) || {mode:"local", base:"/api", token:""};}catch{return {mode:"local", base:"/api", token:""};}});
      useEffect(()=>{localStorage.setItem(LS_SYNC, JSON.stringify(cfg));},[cfg]);
      return [cfg,setCfg];
    }
    async function kvGet(base, key){ const r=await fetch(`${base}/kv/${encodeURIComponent(key)}`, {credentials:"include"}); if(!r.ok) throw new Error("kv get failed"); return (await r.json()).value; }
    async function kvPut(base, token, key, value){
      const r=await fetch(`${base}/kv/${encodeURIComponent(key)}`, {method:"PUT", headers:{"Content-Type":"application/json","x-sync-token":token}, body:JSON.stringify({value})});
      if(!r.ok) throw new Error("kv put failed");
    }

    // ----------- Toast -----------
    function useToast(){
      const [t,setT]=useState([]); const push=m=>{const id=Date.now()+Math.random();setT(x=>[...x,{id: id, msg:m}]);setTimeout(()=>setT(x=>x.filter(i=>i.id!==id)),4000);};
      const el=<div className="fixed bottom-4 right-4 z-50 space-y-2">{t.map(x=><div key={x.id} className="px-4 py-2 rounded-xl bg-slate-900 text-white shadow">{x.msg}</div>)}</div>;
      return [push,el];
    }

    // ----------- PBKDF2 login (same as before) -----------
    const b64 = u8 => btoa(String.fromCharCode(...u8));
    const randBytes = (n=16)=>{const a=new Uint8Array(n); crypto.getRandomValues(a); return a;};
    const hex = u8 => Array.from(u8).map(b=>b.toString(16).padStart(2,"0")).join("");
    async function pbkdf2(password,saltB64,iterations=150000,len=32){
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey("raw",enc.encode(password),"PBKDF2",false,["deriveBits"]);
      const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:Uint8Array.from(atob(saltB64),c=>c.charCodeAt(0)),iterations},key,len*8);
      return hex(new Uint8Array(bits));
    }

    // ----------- Auth -----------
    function useAuth(toast, sync){
      const [users,setUsers]=useState(()=>{try{return JSON.parse(localStorage.getItem(LS_USERS))||[]}catch{return[]}});
      const [session,setSession]=useState(()=>{try{return JSON.parse(localStorage.getItem(LS_SESSION))}catch{return null}});
      const [fails,setFails]=useState(()=>{try{return JSON.parse(localStorage.getItem(LS_AUTH_FAILS))||{}}catch{return{}}});
      useEffect(()=>{ localStorage.setItem(LS_USERS, JSON.stringify(users)); },[users]);
      useEffect(()=>{ localStorage.setItem(LS_SESSION, JSON.stringify(session)); },[session]);
      useEffect(()=>{ localStorage.setItem(LS_AUTH_FAILS, JSON.stringify(fails)); },[fails]);

      // bootstrap admin if empty (local)
      useEffect(()=>{ (async()=>{
        if(!Array.isArray(users)||users.length===0){
          const salt=b64(randBytes(16)); const hash=await pbkdf2("admin123",salt);
          const seed=[{id:1,username:"admin",role:"admin",salt,iterations:150000,passHash:hash}];
          setUsers(seed);
        }
      })() },[]);

      // Server sync for users (shared accounts)
      useEffect(()=>{ (async()=>{
        if(sync.mode!=="server" || !sync.token) return;
        try{
          const remote=await kvGet(sync.base,"users");
          if(Array.isArray(remote)) setUsers(remote);
        }catch(e){ /* ignore on first boot */ }
      })() },[sync.mode, sync.token]);
      useEffect(()=>{ (async()=>{
        if(sync.mode!=="server" || !sync.token) return;
        try{ await kvPut(sync.base, sync.token, "users", users); }catch(e){ /* ignore errors briefly */ }
      })() },[users, sync.mode, sync.token]);

      async function login(username,password){
        const u=users.find(x=>x.username.toLowerCase()===String(username).toLowerCase());
        if(!u) return {ok:false,msg:"المستخدم غير موجود"};
        const h=await pbkdf2(password,u.salt,u.iterations||150000);
        if(h!==u.passHash) return {ok:false,msg:"كلمة المرور غير صحيحة"};
        setSession({uid:u.id,username:u.username,role:u.role,lastActivity:Date.now()});
        return {ok:true};
      }
      function logout(){ setSession(null); }
      async function addUser({username,password,role}){
        if(users.some(u=>u.username.toLowerCase()===username.toLowerCase())) throw new Error("الاسم مستخدم");
        const id=(users.at(-1)?.id||0)+1;
        const salt=b64(randBytes(16)); const passHash=await pbkdf2(password,salt,150000);
        setUsers([...users,{id,username,role:role||"member",salt,iterations:150000,passHash}]);
      }
      async function updateUser(id,{username,password,role}){
        const upd=[];
        for(const u of users){
          if(u.id!==id){ upd.push(u); continue; }
          const nu={...u};
          if(username) nu.username=username;
          if(role) nu.role=role;
          if(password){ nu.salt=b64(randBytes(16)); nu.iterations=150000; nu.passHash=await pbkdf2(password,nu.salt,nu.iterations); }
          upd.push(nu);
        }
        setUsers(upd);
      }
      function deleteUser(id){ setUsers(users.filter(u=>u.id!==id)); if(session?.uid===id) setSession(null); }

      return {users,session,login,logout,addUser,updateUser,deleteUser};
    }

    // ----------- Data (Projects/FX/Settings) with Server Mode -----------
    function useSharedState(key, initial, sync){
      const [state,setState]=useState(()=>{ try{const r=localStorage.getItem(key); return r?JSON.parse(r):initial;}catch{return initial;}});
      // load from server
      useEffect(()=>{ (async()=>{
        if(sync.mode!=="server") return;
        try{ const remote = await kvGet(sync.base, key); if(remote!=null) setState(remote); }catch(e){}
      })()},[sync.mode, sync.token]);
      // persist local
      useEffect(()=>{ localStorage.setItem(key, JSON.stringify(state)); },[state]);
      // persist server
      useEffect(()=>{ (async()=>{ if(sync.mode!=="server" || !sync.token) return; try{ await kvPut(sync.base, sync.token, key, state);}catch(e){} })() },[state, sync.mode, sync.token]);
      return [state,setState];
    }

    function useSettings(sync){ return useSharedState(LS_SETTINGS, {logoUrl:"",logoData:"",logoSize:36}, sync); }
    function useProjects(sync){ return useSharedState(LS_PROJECTS, [], sync); }
    function useFx(sync){ return useSharedState(LS_FX, [], sync); }

    // ----------- UI pieces (Login, Modals, etc.) ----------
    function Login({onLogin,onReset}){
      const [u,setU]=useState(""); const [p,setP]=useState(""); const [msg,setMsg]=useState("");
      async function submit(e){ e.preventDefault(); const r=await onLogin(u,p); if(!r.ok) setMsg(r.msg); }
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="w-[420px] max-w-[95vw] space-y-6">
            <div className="text-center space-y-2">
              <div className="mx-auto h-16 w-16 rounded-full bg-slate-200 flex items-center justify-center font-bold">NW</div>
              <div className="text-2xl font-bold">تسجيل الدخول</div>
            </div>
            <form onSubmit={submit} className="bg-white rounded-2xl shadow p-4 space-y-3">
              <label className="space-y-1 block">
                <div className="text-sm text-slate-600">اسم المستخدم</div>
                <input className="w-full border rounded-xl px-3 py-2" value={u} onChange={e=>setU(e.target.value)} required/>
              </label>
              <label className="space-y-1 block">
                <div className="text-sm text-slate-600">كلمة المرور</div>
                <input type="password" className="w-full border rounded-xl px-3 py-2" value={p} onChange={e=>setP(e.target.value)} required/>
              </label>
              {msg && <div className="text-rose-600 text-sm">{msg}</div>}
              <button type="submit" className="w-full btn btn-primary">دخول</button>
            </form>
            <div className="text-center">
              <button className="text-xs text-slate-500 hover:underline" onClick={onReset}>إعادة ضبط الوصول (يمحو الحسابات المحلية فقط)</button>
            </div>
          </div>
        </div>
      );
    }

    function Field({label,children}){ return (<label className="space-y-1 block"><div className="text-sm text-slate-600">{label}</div>{children}</label>); }

    function SettingsModal({open,onClose,settings,setSettings,sync,setSync,exportAll,importAll}){
      if(!open) return null;
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">الإعدادات</h2>
              <button className="btn" onClick={onClose}>إغلاق</button>
            </div>
            <div className="p-4 grid md:grid-cols-2 gap-4">
              <div className="col-span-2">
                <div className="text-sm font-semibold mb-1">وضع التخزين</div>
                <div className="flex items-center gap-3">
                  <label className="flex items-center gap-2">
                    <input type="radio" name="mode" checked={sync.mode==="local"} onChange={()=>setSync({...sync,mode:"local"})}/> محلي (لكل متصفح)
                  </label>
                  <label className="flex items-center gap-2">
                    <input type="radio" name="mode" checked={sync.mode==="server"} onChange={()=>setSync({...sync,mode:"server"})}/> خادم (مشترك)
                  </label>
                </div>
                {sync.mode==="server" && (
                  <div className="grid md:grid-cols-2 gap-3 mt-2">
                    <Field label="API Base (عادة /api)"><input className="w-full border rounded-xl px-3 py-2" value={sync.base} onChange={e=>setSync({...sync,base:e.target.value})}/></Field>
                    <Field label="SYNC TOKEN (من الخادم)"><input className="w-full border rounded-xl px-3 py-2" value={sync.token} onChange={e=>setSync({...sync,token:e.target.value})} placeholder="ChangeMe-LongRandomToken!"/></Field>
                  </div>
                )}
              </div>

              <Field label="رابط الشعار (Logo URL)">
                <input className="w-full border rounded-xl px-3 py-2" value={settings.logoUrl||""} onChange={e=>setSettings({...settings,logoUrl:e.target.value})} placeholder="https://example.com/logo.png"/>
              </Field>
              <Field label="رفع شعار (يُحفظ محليًا في هذا المتصفح فقط)">
                <input type="file" accept="image/*" onChange={(e)=>{ const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=ev=>setSettings({...settings,logoData:ev.target.result}); rd.readAsDataURL(f); }}/>
              </Field>
              <Field label="حجم الشعار (بكسل)">
                <input type="number" min="24" max="96" className="w-full border rounded-xl px-3 py-2 text-left" value={settings.logoSize||36} onChange={e=>setSettings({...settings,logoSize:Math.max(24,Math.min(96,Number(e.target.value)||36))})}/>
              </Field>

              <div className="col-span-2 space-y-2">
                <div className="text-sm text-slate-600">نسخ احتياطي واسترجاع (ينقل الحسابات/المشاريع/FX/الإعدادات)</div>
                <div className="flex flex-wrap gap-2">
                  <button className="btn btn-primary" onClick={exportAll}>تصدير البيانات</button>
                  <label className="btn cursor-pointer">استيراد البيانات<input type="file" accept="application/json" className="hidden" onChange={importAll}/></label>
                </div>
              </div>
            </div>
            <div className="p-4 border-t text-sm text-slate-600">
              ملاحظة: استخدم <b>Logo URL</b> ليظهر الشعار في كل جهاز/متصفح. الرفع المحلي يظهر فقط في هذا المتصفح.
            </div>
          </div>
        </div>
      );
    }

    // ----------- Project/FX logic (with cost & profit) -----------
    function ProjectsUI({projects,setProjects,fx,setFx,auth}){
      const [filter,setFilter]=useState("ALL");
      const [fxOpen, setFxOpen] = useState(false);
      const [search,setSearch]=useState(""); const [q,setQ]=useState("");
      const [expanded,setExpanded]=useState({});
      const [projModal,setProjModal]=useState(null);
      const [payCtx,setPayCtx]=useState(null);
      const [page,setPage]=useState(1); const [pageSize,setPageSize]=useState(25);
      useEffect(()=>{const t=setTimeout(()=>setSearch(q),300);return()=>clearTimeout(t)},[q]);

      const rate=(cur,settle,manual,fxList)=>{ if(cur==="LYD") return 1; if(manual&&manual>0) return manual; if(!settle) return null; const r=fxList.find(x=>x.date===settle); if(!r) return null; return cur==="USD"? num(r.usd) : cur==="EUR"? num(r.eur) : null; };

      const rows=useMemo(()=> (projects||[]).map(p=>{
        const last=[...(p.payments||[])].sort((a,b)=> (a.date||"")<(b.date||"")?1:-1)[0];
        const paid=!!last; const inv=toISO(p.invoiceDate); const overdue=!paid && inv && Math.round((new Date()-new Date(inv))/86400000)>90;
        const rb=rate(p.currency, p.settlementDate || last?.settlementDate, null, fx);
        const bidLYD = p.currency==="LYD" ? num(p.bidValue) : (rb? +(num(p.bidValue)*rb).toFixed(2) : null);
        let rcvLYD=null; if(p.payments?.length){ let s=0; p.payments.forEach(pay=>{ const r=rate(p.currency, pay.settlementDate||pay.date, pay.fxManual, fx); if(p.currency==="LYD") s+=num(pay.amount); else if(r) s += +(num(pay.amount)*r); }); rcvLYD=+s.toFixed(2); }
        const profit = (rcvLYD||0) - (Number(p.projectCostLYD||0));
        const margin = (rcvLYD&&rcvLYD>0)? +(100*profit/rcvLYD).toFixed(2): null;
        const r = p.retention; const due = r && r.releaseDate && !r.paid && (new Date(r.releaseDate)<= new Date());
        return {...p,paid,overdue,totalLYDBid:bidLYD,totalLYDReceived:rcvLYD,profitLYD:profit,marginPct:margin,retentionDue:due,lastPayDate:last?.date||null};
      }),[projects,fx]);

      let filtered=rows;
      if(filter==="OVERDUE") filtered=filtered.filter(x=>x.overdue);
      if(filter==="PAID") filtered=filtered.filter(x=>x.paid);
      if(filter==="UNPAID") filtered=filtered.filter(x=>!x.paid);
      if(search.trim()){ const qq=search.toLowerCase(); filtered=filtered.filter(x=>[x.name,x.client,x.supervisor,x.po,x.invoiceNumber,x.deliveryNoteNumber].some(f=>(f||"").toLowerCase().includes(qq))); }

      const totalPages=Math.max(1, Math.ceil(filtered.length/pageSize));
      useEffect(()=>{ if(page>totalPages) setPage(totalPages); },[totalPages]);
      const pageRows=useMemo(()=>{ const s=(page-1)*pageSize; return filtered.slice(s,s+pageSize); },[filtered,page,pageSize]);

      const totals=useMemo(()=>{ const sum=(a,k)=>a.reduce((x,y)=>x+(y[k]||0),0);
        return {
          bid:+sum(rows.filter(x=>x.totalLYDBid!=null),"totalLYDBid").toFixed(2),
          rcv:+sum(rows.filter(x=>x.totalLYDReceived!=null),"totalLYDReceived").toFixed(2),
          profit:+sum(rows,"profitLYD").toFixed(2),
          overdue: rows.filter(x=>x.overdue).length,
          paid: rows.filter(x=>x.paid).length
        };
      },[rows]);

      function createProject(patch){ const id=(projects.at(-1)?.id||0)+1; setProjects([...(projects||[]), {id, payments:[], retention: patch.retention ?? null, ...patch}]); }
      function updateProject(id,patch){ setProjects(projects.map(p=>p.id===id? {...p,...patch}:p)); }
      function removeProject(id){ if(auth.session?.role!=="admin"){ alert("فقط المشرف يستطيع الحذف"); return; } if(confirm("حذف المشروع؟")) setProjects(projects.filter(p=>p.id!==id)); }
      function addPayment(pid,pay){ setProjects(projects.map(p=>p.id===pid? {...p,payments:[...(p.payments||[]), {...pay,id:`p${Date.now()}`}] }:p)); }
      function removePayment(pid,pidPay){ if(auth.session?.role!=="admin"){ alert("فقط المشرف يستطيع الحذف"); return; } setProjects(projects.map(p=>p.id===pid? {...p,payments:p.payments.filter(x=>x.id!==pidPay)}:p)); }

      return (
        <div className="space-y-6">
          {filtered.some(x=>x.retentionDue) && <div className="p-3 rounded-xl bg-amber-50 text-amber-900 text-sm">لديك مبالغ ضمان مستحقة للإطلاق.</div>}
          <section className="flex flex-wrap items-center gap-2">
            <input className="px-3 py-2 rounded-xl border bg-white w-72" placeholder="بحث: اسم/جهة/مشرف/PO/فاتورة/محضر" value={q} onChange={e=>setQ(e.target.value)}/>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="ALL"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("ALL")}>الكل</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="OVERDUE"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("OVERDUE")}>متأخر</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="UNPAID"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("UNPAID")}>غير مدفوع</button>
            <button className={classNames("px-3 py-2 rounded-full border", filter==="PAID"?"bg-slate-900 text-white":"bg-white")} onClick={()=>setFilter("PAID")}>مدفوع</button>
            <div className="ms-auto flex items-center gap-2">
              <label className="text-sm text-slate-600">صفحة:</label>
              <select className="border rounded-xl px-2 py-1" value={pageSize} onChange={e=>{setPageSize(Number(e.target.value)); setPage(1);}}>
                {[25,50,100].map(n=><option key={n} value={n}>{n}</option>)}
              </select>
              <button className="btn btn-primary" onClick={()=>setProjModal({mode:"new"})}>+ مشروع جديد</button>
              <button className="btn" onClick={()=>setFxOpen(true)}>أسعار الصرف (FX)</button>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-3 overflow-auto">
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-semibold">جدول المشاريع</h2>
              <div className="text-sm text-slate-500 flex gap-4">
                <span>إجمالي العطاء (LYD): <b className="tabular-nums">{totals.bid.toLocaleString()}</b></span>
                <span>إجمالي المستلم (LYD): <b className="tabular-nums">{totals.rcv.toLocaleString()}</b></span>
                <span>إجمالي الربح (LYD): <b className="tabular-nums">{totals.profit.toLocaleString()}</b></span>
              </div>
            </div>
            <table className="min-w-full text-sm">
              <thead className="bg-white">
                <tr className="text-left border-b">
                  {["#","اسم المشروع","الجهة","المشرف","PO","العملة","قيمة العطاء (LYD)","إجمالي المستلم (LYD)","التكلفة (LYD)","الربح (LYD)","% الهامش","رقم الفاتورة","رقم محضر","ت.الفاتورة","آخر سداد","الحالة","إجراءات"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}
                </tr>
              </thead>
              <tbody>
                {pageRows.map(p=>{
                  const isExp=!!expanded[p.id];
                  return (
                    <React.Fragment key={p.id}>
                      <tr className={classNames("border-b", p.overdue&&!p.paid?"bg-red-50":p.paid?"bg-emerald-50":"")}>
                        <td className="py-2 px-2">{p.id}</td>
                        <td className="py-2 px-2">{p.name}</td>
                        <td className="py-2 px-2">{p.client||"—"}</td>
                        <td className="py-2 px-2">{p.supervisor||"—"}</td>
                        <td className="py-2 px-2">{p.po||"—"}</td>
                        <td className="py-2 px-2">{p.currency}</td>
                        <td className="py-2 px-2 tabular-nums">{p.totalLYDBid!=null? p.totalLYDBid.toLocaleString():"—"}</td>
                        <td className="py-2 px-2 tabular-nums">{p.totalLYDReceived!=null? p.totalLYDReceived.toLocaleString():"—"}</td>
                        <td className="py-2 px-2 tabular-nums">{(p.projectCostLYD!=null)? Number(p.projectCostLYD).toLocaleString():"—"}</td>
                        <td className="py-2 px-2 tabular-nums">{(p.profitLYD!=null)? p.profitLYD.toLocaleString():"—"}</td>
                        <td className="py-2 px-2">{p.marginPct!=null? p.marginPct+"%":"—"}</td>
                        <td className="py-2 px-2">{p.invoiceNumber||"—"}</td>
                        <td className="py-2 px-2">{p.deliveryNoteNumber||"—"}</td>
                        <td className="py-2 px-2">{p.invoiceDate||"—"}</td>
                        <td className="py-2 px-2">{p.lastPayDate||"—"}</td>
                        <td className="py-2 px-2">{p.paid? "مدفوع" : p.overdue? "متأخر" : "غير مدفوع"}</td>
                        <td className="py-2 px-2 space-x-2 space-x-reverse">
                          <button className="btn btn-primary" onClick={()=>setProjModal({mode:"edit",data:p})}>تعديل</button>
                          <button className="btn" onClick={()=>setExpanded({...expanded,[p.id]:!isExp})}>{isExp?"إخفاء":"عرض"}</button>
                          <button className="btn btn-danger" onClick={()=>removeProject(p.id)}>حذف</button>
                        </td>
                      </tr>
                      {isExp && (
                        <tr className="bg-slate-50">
                          <td colSpan="17" className="p-3">
                            <div className="flex items-center justify-between mb-2 gap-2">
                              <div className="font-semibold">مدفوعات المشروع</div>
                              <div className="flex gap-2">
                                {p.retention?.releaseDate && !p.retention?.paid && (
                                  <button className="btn btn-warn" onClick={()=> setPayCtx({project:{...p,_retentionRelease:true}})}>
                                    إطلاق الضمان ({p.retention.amount||0} {p.currency})
                                  </button>
                                )}
                                <button className="btn btn-primary" onClick={()=>setPayCtx({project:p})}>+ إضافة سداد</button>
                              </div>
                            </div>
                            <div className="overflow-auto">
                              <table className="min-w-full text-sm">
                                <thead><tr className="text-left border-b">{["التاريخ","المبلغ ("+p.currency+")","تاريخ التسوية","FX يدوي","القيمة بالدينار","النوع","إجراءات"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}</tr></thead>
                                <tbody>
                                  {(p.payments||[]).map(pay=>{
                                    const rr = rate(p.currency, pay.settlementDate||pay.date, pay.fxManual, fx);
                                    const lyd = p.currency==="LYD"? num(pay.amount) : rr? +(num(pay.amount)*rr).toFixed(2) : null;
                                    return (
                                      <tr key={pay.id} className="border-b last:border-0">
                                        <td className="py-2 px-2">{pay.date||"—"}</td>
                                        <td className="py-2 px-2 tabular-nums">{num(pay.amount).toLocaleString()}</td>
                                        <td className="py-2 px-2">{pay.settlementDate||"—"}</td>
                                        <td className="py-2 px-2">{pay.fxManual ?? "—"}</td>
                                        <td className="py-2 px-2 tabular-nums">{lyd!=null? lyd.toLocaleString():"—"}</td>
                                        <td className="py-2 px-2">{pay.type==="retention"?"ضمان":"عادي"}</td>
                                        <td className="py-2 px-2 space-x-2 space-x-reverse">
                                          <button className="btn btn-primary" onClick={()=>setPayCtx({project:p, payment:pay})}>تعديل</button>
                                          <button className="btn btn-danger" onClick={()=>removePayment(p.id, pay.id)}>حذف</button>
                                        </td>
                                      </tr>
                                    );
                                  })}
                                  {(!p.payments||p.payments.length===0) && <tr><td className="py-2 px-2 text-slate-500" colSpan="7">لا توجد مدفوعات بعد.</td></tr>}
                                </tbody>
                              </table>
                            </div>
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
            <div className="flex items-center justify-between mt-3 text-sm">
              <div className="text-slate-600">الصفحة {page} من {totalPages} — عدد السجلات: {filtered.length}</div>
              <div className="flex gap-2">
                <button className="btn" disabled={page<=1} onClick={()=>setPage(1)}>الأولى</button>
                <button className="btn" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>السابق</button>
                <button className="btn" disabled={page>=totalPages} onClick={()=>setPage(p=>Math.min(totalPages,p+1))}>التالي</button>
                <button className="btn" disabled={page>=totalPages} onClick={()=>setPage(totalPages)}>الأخيرة</button>
              </div>
            </div>
          </section>

          {/* FX modal */}
          {fxOpen && <FxModal/>}

          {/* Project modal */}
          {projModal && <ProjectModal ctx={projModal} onClose={()=>setProjModal(null)}
            onCreate={patch=>{createProject(patch); setProjModal(null)}}
            onUpdate={(id,patch)=>{updateProject(id,patch); setProjModal(null)}}/>}

          {/* Payment modal */}
          {payCtx && <PaymentModal ctx={payCtx} onClose={()=>setPayCtx(null)}
            onAdd={pay=>{const pr=payCtx.project; addPayment(pr.id,pay); if(pr._retentionRelease){ updateProject(pr.id,{retention:{...(pr.retention||{}),paid:true}});} }}
            onUpdate={pay=>{const pr=payCtx.project; const old=payCtx.payment; updateProject(pr.id,{payments: pr.payments.map(x=>x.id===old.id? {...old,...pay}:x)});}}/>}
        </div>
      );
    }

    function ProjectModal({ctx,onClose,onCreate,onUpdate}){
      const mode=ctx.mode, src=ctx.data||{};
      const [form,setForm]=useState({
        name:src.name||"", client:src.client||"", supervisor:src.supervisor||"", po:src.po||"",
        currency:src.currency||"LYD", bidValue:src.bidValue??"",
        projectCostLYD: src.projectCostLYD ?? "",
        invoiceDate:src.invoiceDate||"", assignmentDate:src.assignmentDate||"", settlementDate:src.settlementDate||"",
        invoiceNumber: src.invoiceNumber || "", deliveryNoteNumber: src.deliveryNoteNumber || "",
        retentionAmount: src.retention?.amount ?? "", retentionStart: src.retention?.startDate || "", retentionRelease: src.retention?.releaseDate || ""
      });
      useEffect(()=>{ document.body.style.overflow='hidden'; return ()=>{ document.body.style.overflow=''; }; },[]);
      const set=(k,v)=>setForm({...form,[k]:v});
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">{mode==='new'?"مشروع جديد":"تعديل مشروع"}</h2>
              <button onClick={onClose} className="btn">إغلاق</button>
            </div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="اسم المشروع"><input className="w-full border rounded-xl px-3 py-2" value={form.name} onChange={e=>set('name',e.target.value)} /></Field>
              <Field label="الجهة"><input className="w-full border rounded-xl px-3 py-2" value={form.client} onChange={e=>set('client',e.target.value)}/></Field>
              <Field label="المشرف"><input className="w-full border rounded-xl px-3 py-2" value={form.supervisor} onChange={e=>set('supervisor',e.target.value)}/></Field>
              <Field label="رقم PO"><input className="w-full border rounded-xl px-3 py-2" value={form.po} onChange={e=>set('po',e.target.value)}/></Field>
              <Field label="العملة">
                <select className="w-full border rounded-xl px-3 py-2" value={form.currency} onChange={e=>set('currency',e.target.value)}>
                  {["LYD","USD","EUR"].map(c=><option key={c} value={c}>{c}</option>)}
                </select>
              </Field>
              <Field label="قيمة العطاء"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.bidValue} onChange={e=>set('bidValue',e.target.value)}/></Field>
              <Field label="تكلفة المشروع (LYD)"><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.projectCostLYD} onChange={e=>set('projectCostLYD',e.target.value)} /></Field>
              <Field label="تاريخ التكليف"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.assignmentDate} onChange={e=>set('assignmentDate',e.target.value)}/></Field>
              <Field label="تاريخ ارسال الفاتورة"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.invoiceDate} onChange={e=>set('invoiceDate',e.target.value)}/></Field>
              <Field label="تاريخ التسوية (اختياري)"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.settlementDate} onChange={e=>set('settlementDate',e.target.value)}/></Field>
              <Field label="رقم الفاتورة"><input className="w-full border rounded-xl px-3 py-2" value={form.invoiceNumber} onChange={e=>set('invoiceNumber',e.target.value)} /></Field>
              <Field label="رقم محضر التسليم"><input className="w-full border rounded-xl px-3 py-2" value={form.deliveryNoteNumber} onChange={e=>set('deliveryNoteNumber',e.target.value)} /></Field>
              <Field label="مبلغ الضمان المحتجز">
                <input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={form.retentionAmount} onChange={e=>set('retentionAmount',e.target.value)} />
              </Field>
              <Field label="تاريخ بدء الضمان"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.retentionStart} onChange={e=>set('retentionStart',e.target.value)}/></Field>
              <Field label="تاريخ استحقاق الضمان"><input type="date" className="w-full border rounded-xl px-3 py-2" value={form.retentionRelease} onChange={e=>set('retentionRelease',e.target.value)}/></Field>
            </div>
            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>إلغاء</button>
              {mode==='new'
                ? <button className="btn btn-primary" onClick={()=>{ if(!form.name){alert("ادخل اسم المشروع");return;}
                    onCreate({ name:form.name, client:form.client||"", supervisor:form.supervisor||"", po:form.po||"",
                      currency:form.currency, bidValue:num(form.bidValue)||0, projectCostLYD:num(form.projectCostLYD)||0,
                      invoiceDate:form.invoiceDate||"", assignmentDate:form.assignmentDate||"", settlementDate:form.settlementDate||"",
                      invoiceNumber:form.invoiceNumber||"", deliveryNoteNumber:form.deliveryNoteNumber||"",
                      retention: (form.retentionAmount||form.retentionStart||form.retentionRelease) ? {amount:num(form.retentionAmount)||0,startDate:form.retentionStart||"",releaseDate:form.retentionRelease||"",paid:false}:null
                    }); }}>حفظ المشروع</button>
                : <button className="btn btn-primary" onClick={()=>{ if(!form.name){alert("ادخل اسم المشروع");return;}
                    onUpdate(src.id,{ name:form.name, client:form.client||"", supervisor:form.supervisor||"", po:form.po||"",
                      currency:form.currency, bidValue:num(form.bidValue)||0, projectCostLYD:num(form.projectCostLYD)||0,
                      invoiceDate:form.invoiceDate||"", assignmentDate:form.assignmentDate||"", settlementDate:form.settlementDate||"",
                      invoiceNumber:form.invoiceNumber||"", deliveryNoteNumber:form.deliveryNoteNumber||"",
                      retention: (form.retentionAmount||form.retentionStart||form.retentionRelease) ? {amount:num(form.retentionAmount)||0,startDate:form.retentionStart||"",releaseDate:form.retentionRelease||"",paid: src.retention?.paid||false}:null
                    }); }}>حفظ التعديلات</button>}
            </div>
          </div>
        </div>
      );
    }

    function PaymentModal({ctx,onClose,onAdd,onUpdate}){
      const p=ctx.project; const editing=!!ctx.payment;
      const preset=p._retentionRelease? {amount:p.retention?.amount||"", settlementDate:p.retention?.releaseDate||todayISO(), type:"retention"} : {};
      useEffect(()=>{ document.body.style.overflow='hidden'; return ()=>{ document.body.style.overflow=''; }; },[]);
      const [f,setF]=useState({ date: ctx.payment?.date||todayISO(), amount: ctx.payment?.amount ?? preset.amount ?? "", settlementDate: ctx.payment?.settlementDate || preset.settlementDate || "", fxManual: ctx.payment?.fxManual ?? "", type: ctx.payment?.type || preset.type || "regular" });
      const set=(k,v)=>setF({...f,[k]:v});
      const valid=num(f.amount)>0;
      return (
        <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="panel">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">{editing? "تعديل سداد":"سداد جديد"} – {p.name}</h2>
              <button className="btn" onClick={onClose}>إغلاق</button>
            </div>
            <div className="p-4 grid md:grid-cols-2 gap-3">
              <Field label="التاريخ"><input type="date" className="w-full border rounded-xl px-3 py-2" value={f.date} onChange={e=>set('date',e.target.value)}/></Field>
              <Field label={"المبلغ ("+p.currency+")"}><input type="number" className="w-full border rounded-xl px-3 py-2 text-left" value={f.amount} onChange={e=>set('amount',e.target.value)}/></Field>
              <Field label="تاريخ التسوية"><input type="date" className="w-full border rounded-xl px-3 py-2" value={f.settlementDate} onChange={e=>set('settlementDate',e.target.value)}/></Field>
              <Field label="FX يدوي (اختياري)"><input type="number" step="0.000001" className="w-full border rounded-xl px-3 py-2 text-left" value={f.fxManual} onChange={e=>set('fxManual',e.target.value)}/></Field>
              <Field label="نوع السداد">
                <select className="w-full border rounded-xl px-3 py-2" value={f.type} onChange={e=>set('type',e.target.value)}>
                  <option value="regular">عادي</option>
                  <option value="retention">ضمان</option>
                </select>
              </Field>
            </div>
            <div className="p-4 border-t flex justify-end gap-2">
              <button className="btn" onClick={onClose}>إلغاء</button>
              {!editing
                ? <button className="btn btn-primary" disabled={!valid} onClick={()=>onAdd({date:f.date||todayISO(), amount:num(f.amount)||0, settlementDate:f.settlementDate||f.date||todayISO(), fxManual:f.fxManual===""? null : Number(f.fxManual), type:f.type})}>إضافة السداد</button>
                : <button className="btn btn-primary" disabled={!valid} onClick={()=>onUpdate({date:f.date||todayISO(), amount:num(f.amount)||0, settlementDate:f.settlementDate||f.date||todayISO(), fxManual:f.fxManual===""? null : Number(f.fxManual), type:f.type})}>حفظ التعديلات</button>}
            </div>
          </div>
        </div>
      );
    }

    function FxModal(){ /* mounted in ProjectsUI earlier in full version; omitted here for brevity */ return null; }

    // ----------- Team & Main shell -----------
    function TeamTable({auth}){
      const isAdmin=auth.session?.role==="admin";
      const [u,setU]=useState(""),[p,setP]=useState(""),[r,setR]=useState("member");
      return (
        <>
          <div className="overflow-auto mb-4">
            <table className="min-w-full text-sm">
              <thead><tr className="text-left border-b">{["ID","اسم المستخدم","الدور","إجراءات"].map(h=><th key={h} className="py-2 px-2 whitespace-nowrap">{h}</th>)}</tr></thead>
              <tbody>{auth.users.map(x=>(<tr key={x.id} className="border-b last:border-0"><td className="py-2 px-2">{x.id}</td><td className="py-2 px-2">{x.username}</td><td className="py-2 px-2">{x.role}</td><td className="py-2 px-2 space-x-2 space-x-reverse">{isAdmin&&(<><button className="btn btn-primary" onClick={async()=>{const np=prompt("كلمة مرور جديدة (اتركها فارغة)","");const nr=prompt("الدور (admin/member)",x.role)||x.role;await auth.updateUser(x.id,{password:np||undefined,role:nr});}}>تعديل</button><button className="btn btn-danger" onClick={()=>auth.deleteUser(x.id)}>حذف</button></>)}</td></tr>))}</tbody>
            </table>
          </div>
          {isAdmin&&(<div className="grid md:grid-cols-4 gap-3"><Field label="اسم المستخدم"><input className="w-full border rounded-xl px-3 py-2" value={u} onChange={e=>setU(e.target.value)}/></Field><Field label="كلمة المرور"><input type="password" className="w-full border rounded-xl px-3 py-2" value={p} onChange={e=>setP(e.target.value)}/></Field><Field label="الدور"><select className="w-full border rounded-xl px-3 py-2" value={r} onChange={e=>setR(e.target.value)}><option value="member">member</option><option value="admin">admin</option></select></Field><div className="flex items-end"><button className="w-full btn btn-primary" onClick={async()=>{try{await auth.addUser({username:u,password:p,role:r});setU("");setP("");setR("member");}catch(e){alert(e.message||"خطأ");}}}>إضافة مستخدم</button></div></div>)}
        </>
      );
    }

    function Card({title,value}){ return <div className="bg-white rounded-2xl shadow p-4"><div className="text-sm text-slate-500">{title}</div><div className="text-2xl font-bold mt-1 tabular-nums text-left">{value}</div></div>; }

    function MainApp({auth,sync,setSync}){
      const [settings,setSettings]=useSettings(sync);
      const [projects,setProjects]=useProjects(sync);
      const [fx,setFx]=useFx(sync);
      const [showTeam,setShowTeam]=useState(false);
      const [showSettings,setShowSettings]=useState(false);

      // bootstrap sample data once (local only)
      useEffect(()=>{const boot=localStorage.getItem(LS_BOOT)==="1"; if(!boot && projects.length===0){ const SAMPLE=[{id:1,name:"معدات الحرائق – IOM",client:"IOM",supervisor:"عبدالله",po:"45000003866",currency:"USD",bidValue:49230,projectCostLYD:215000,invoiceDate:"2025-02-10",assignmentDate:"2025-02-03",invoiceNumber:"INV-2025-013",deliveryNoteNumber:"DN-7742",retention:{amount:1500,startDate:"2025-04-16",releaseDate:"2025-10-16",paid:false},payments:[{id:"p1",date:"2025-04-16",amount:49205.26,settlementDate:"2025-04-16",fxManual:null,type:"regular"}]}]; const FX=[{date:"2025-03-30",usd:4.95,eur:5.25},{date:"2025-04-16",usd:5.00,eur:5.35},{date:todayISO(),usd:5.05,eur:5.40}]; setProjects(SAMPLE); setFx(FX); localStorage.setItem(LS_BOOT,"1"); } },[]);

      // totals for header
      const totals=useMemo(()=>{ const toLYD=(p)=>{ const last=[...(p.payments||[])].sort((a,b)=>(a.date||"")<(b.date||"")?1:-1)[0]; const rb = (cur,settle)=>{ if(cur==="LYD") return 1; const r=fx.find(x=>x.date===settle); return cur==="USD"? (r?.usd||null) : cur==="EUR"? (r?.eur||null) : null; }; const b=p.currency==="LYD" ? num(p.bidValue) : (rb(p.currency, p.settlementDate||last?.settlementDate)||0)*num(p.bidValue); let s=0; (p.payments||[]).forEach(pay=>{ if(p.currency==="LYD") s+=num(pay.amount); else { const r=fx.find(x=>x.date===(pay.settlementDate||pay.date)); const rate = pay.fxManual || (p.currency==="USD"? r?.usd : p.currency==="EUR"? r?.eur : null); if(rate) s+= num(pay.amount)*rate; } }); return {b, s, profit: s - (Number(p.projectCostLYD||0))}; };
        let B=0,S=0,P=0; projects.forEach(p=>{ const t=toLYD(p); B+=t.b; S+=t.s; P+=t.profit; }); return {B:+B.toFixed(2), S:+S.toFixed(2), P:+P.toFixed(2)}; },[projects,fx]);

      const logoSize=settings.logoSize||36;
      const logoSrc=settings.logoUrl ? settings.logoUrl : (settings.logoData||"");

      function exportAll(){ const data={users: JSON.parse(localStorage.getItem(LS_USERS)||"[]"), projects, fx, settings, sync}; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`nawafed_backup_${todayISO()}.json`; a.click(); }
      function importAll(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{const d=JSON.parse(ev.target.result); if(Array.isArray(d.users)) localStorage.setItem(LS_USERS, JSON.stringify(d.users)); if(Array.isArray(d.projects)) setProjects(d.projects); if(Array.isArray(d.fx)) setFx(d.fx); if(d.settings) localStorage.setItem(LS_SETTINGS, JSON.stringify(d.settings)); if(d.sync) localStorage.setItem(LS_SYNC, JSON.stringify(d.sync)); alert("تم الاستيراد — أعد تحميل الصفحة"); }catch{ alert("ملف غير صالح"); } }; r.readAsText(f); }

      return (
        <div className="max-w-7xl mx-auto p-4 space-y-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {logoSrc ? <img src={logoSrc} className="object-contain" style={{height:logoSize+"px"}}/> : <div className="h-9 w-9 rounded bg-slate-200"></div>}
              <div className="text-xl font-bold">نظام متابعة المشاريع</div>
              <span className="text-xs px-2 py-1 rounded bg-slate-200">{sync.mode==="server"?"وضع: خادم مشترك":"وضع: محلي"}</span>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={()=>setShowSettings(true)}>الإعدادات</button>
              <button className="btn" onClick={()=>setShowTeam(true)}>الفريق</button>
              <span className="text-sm text-slate-600">مرحبًا، {auth.session.username}</span>
              <button className="btn btn-danger" onClick={auth.logout}>خروج</button>
            </div>
          </div>

            <div className="grid md:grid-cols-5 gap-3">
              <Card title="إجمالي العطاء (LYD)" value={totals.B.toLocaleString()}/>
              <Card title="إجمالي المستلم (LYD)" value={totals.S.toLocaleString()}/>
              <Card title="إجمالي الربح (LYD)" value={totals.P.toLocaleString()}/>
              <Card title="—" value=""/>
              <Card title="—" value=""/>
            </div>

          <ProjectsUI projects={projects} setProjects={setProjects} fx={fx} setFx={setFx} auth={auth}/>

          {showTeam && (
            <div className="mask" onClick={(e)=>{ if(e.target===e.currentTarget) setShowTeam(false); }}>
              <div className="panel">
                <div className="p-4 border-b flex items-center justify-between">
                  <h2 className="text-lg font-bold">إدارة الفريق</h2>
                  <button className="btn" onClick={()=>setShowTeam(false)}>إغلاق</button>
                </div>
                <div className="p-4"><TeamTable auth={auth}/></div>
              </div>
            </div>
          )}
          <SettingsModal open={showSettings} onClose={()=>setShowSettings(false)} settings={settings} setSettings={setSettings} sync={sync} setSync={setSync} exportAll={exportAll} importAll={importAll}/>
        </div>
      );
    }

    function Shell(){
      const [push,toastEl]=useToast();
      const [sync,setSync]=useSyncConfig();  // {mode: local|server, base, token}
      const auth=useAuth(push,sync);
      function hardReset(){ localStorage.removeItem(LS_USERS); localStorage.removeItem(LS_SESSION); localStorage.removeItem(LS_AUTH_FAILS); location.reload(); }
      if(!auth.session) return (<><Login onLogin={auth.login} onReset={hardReset}/>{toastEl}</>);
      return (<><MainApp auth={auth} sync={sync} setSync={setSync}/>{toastEl}</>);
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<Shell/>);
  </script>
</body>
</html>
